/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,i,d){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;var e=d.mvc.View.extend({MINIMAL_PREVIEW_SIZE:10,className:"tree-layout",documentEvents:{mousemove:"onPointermove",touchmove:"onPointermove",mouseup:"onPointerup",touchend:"onPointerup"},options:{previewAttrs:{parent:{rx:2,ry:2}},useModelGeometry:!1,clone:function(t){return t.clone()},canInteract:function(){return!0},validateConnection:null,paperConstructor:d.dia.Paper,paperOptions:null,reconnectElements:null,translateElements:null},init:function(){this.toggleDefaultInteraction(!1),this.startListening(),this.render(),this.onSetTheme(null,this.theme)},startListening:function(){var t=this.options.paper;this.listenTo(t,"element:pointerdown",this.canInteract(this.onPointerdown))},toggleDefaultInteraction:function(t){this.options.paper.setInteractivity(t)},render:function(){var t=this.options.paper;this.$activeBox=i("<div>").addClass("tree-layout-box active hidden").appendTo(this.el);var e=d.util.assign({},this.options.paperOptions,{interactive:!1,width:"100%",height:"100%"});return this.draggingPaper=new this.options.paperConstructor(e),this.draggingPaper.undelegateEvents(),this.$translateBox=i("<div>").addClass("tree-layout-box translate hidden").append(this.draggingPaper.render().el).appendTo(this.el),this.$mask=i("<div>").addClass("tree-layout-mask"),this.svgViewport=d.V(t.cells),this.svgPreviewChild=d.V(this.renderChildPreview()).attr(this.options.previewAttrs.child||{}).addClass("tree-layout-preview child"),this.svgPreviewConnection=d.V(this.renderConnectionPreview()).attr(this.options.previewAttrs.link||{}).addClass("tree-layout-preview link"),this.svgPreviewParent=d.V(this.renderParentPreview()).attr(this.options.previewAttrs.parent||{}).addClass("tree-layout-preview parent"),this.svgPreview=d.V("g").addClass("tree-layout-preview-group").append([this.svgPreviewConnection,this.svgPreviewParent,this.svgPreviewChild]),this.$el.appendTo(t.el),this},renderChildPreview:function(){return d.V("circle")},renderParentPreview:function(){return d.V("rect")},renderConnectionPreview:function(){return d.V("path")},onSetTheme:function(e,i){[this.svgPreview,this.$mask].forEach(function(t){t&&(e&&t.removeClass(this.themeClassNamePrefix+e),t.addClass(this.themeClassNamePrefix+i))},this)},onRemove:function(){this.svgPreview.remove()},toggleDropping:function(t){this.$mask.toggleClass("dropping-not-allowed",!t),this.$translateBox.toggleClass("no-drop",!t)},canDrop:function(){return this.isActive()&&!this.$translateBox.hasClass("no-drop")},isActive:function(){return!this.$translateBox.hasClass("hidden")},_startDrag:function(t,e,i){var n=this.options.paper;this.$mask.appendTo(n.el),this.toggleDropping(!1),this.ctm=n.matrix();var o=t[0],s=o.findView(n).getBBox({useModelGeometry:this.options.useModelGeometry});this.updateBox(this.$translateBox,d.util.defaults({x:e,y:i},s)),this.updateBox(this.$activeBox,s),this.$activeBox.removeClass("hidden"),this.$translateBox.removeClass("hidden"),this.prepareDraggingPaper(o)},updateBox:function(t,e){t.css({width:e.width,height:e.height,left:e.x,top:e.y})},positionTranslateBox:function(t){var e=d.V.transformPoint(t,this.ctm);this.$translateBox.css({left:e.x,top:e.y})},prepareDraggingPaper:function(t){var e=this.options.clone(t).position(0,0);this.draggingPaper.scale(this.ctm.a,this.ctm.d),this.draggingPaper.model.resetCells([e])},_doDrag:function(t,e,i){var n,o,s=this.model,r={x:e,y:i};if(this.candidate&&(this.candidate=null,this.hidePreview()),this.positionTranslateBox(r),(n=s.getMinimalRootAreaByPoint(r))&&(o=n.findMinimalAreaByPoint(r,{expandBy:Math.min(s.get("siblingGap"),s.get("gap"))/2})),o){var a=this.findDirection(o,r),h=o.getLayoutSiblings(a),l=h.getSiblingRankByPoint(r);d.util.toArray(t).every(function(t){return this.isConnectionValid(t,h,l)},this)?(this.candidate={id:o.root.id,direction:a,siblingRank:l},this.updatePreview(h,l),this.showPreview(),this.toggleDropping(!0)):this.toggleDropping(!1)}else this.toggleDropping(!0)},_finishDrag:function(t,e,i){this.$mask.remove().removeClass("dropping-not-allowed");var n=this.candidate,o=this.options;if(n){var s=o.reconnectElements;"function"==typeof s?s.apply(this,[t,o.paper.getModelById(n.id),n.siblingRank,n.direction,this]):this.reconnectElements(t,n),this.candidate=null}else if(this.canDrop()){var r=o.translateElements;"function"==typeof r?r.call(this,t,e,i,this):this.translateElements(t,e,i)}this.$activeBox.addClass("hidden"),this.$translateBox.addClass("hidden"),this.hidePreview()},reconnectElement:function(t,e){var i=e.siblingRank+.5,n={direction:e.direction,siblingRank:i,ui:!0};if(!this.model.reconnectElement(t,e.id,n)){var o=this.options.paper,s=o.getDefaultLink(t.findView(o));s.set({source:{id:e.id},target:{id:t.id}}),s.addTo(o.model,n),this.model.changeSiblingRank(t,i,n),this.model.changeDirection(t,e.direction,n);var r=this.model.getAttribute(t,"direction");this.model.updateDirections(t,[r,e.direction],n)}},reconnectElements:function(t,e){t.forEach(function(t){this.reconnectElement(t,e)},this),this.layout()},translateElement:function(t,e,i){var n=this.model.graph.getConnectedLinks(t,{inbound:!0});d.util.invoke(n,"remove");var o=t.get("size");t.set("position",{x:e-o.width/2,y:i-o.height/2},{ui:!0})},translateElements:function(t,e,i){t.forEach(function(t){this.translateElement(t,e,i)},this),this.layout()},layout:function(){this.model.layout({ui:!0,treeLayoutView:this.cid})},updatePreview:function(t,e){var i=t.parentArea.root,n=Math.max(this.model.get("siblingGap")/2,this.MINIMAL_PREVIEW_SIZE),o={width:n,height:n},s=t.getNeighborPointFromRank(e),r=t.getConnectionPoints(s,{ignoreSiblings:!0}),a=t.getParentConnectionPoint(),h=t.getChildConnectionPoint(s,o);this.updateParentPreview(i.position(),i.size(),i),this.updateChildPreview(s,o),this.updateConnectionPreview(a,h,r)},showPreview:function(){this.svgViewport.append(this.svgPreview)},hidePreview:function(){this.svgPreview.remove()},updateParentPreview:function(t,e){this.svgPreviewParent.attr({x:t.x,y:t.y,width:e.width,height:e.height})},updateChildPreview:function(t,e){this.svgPreviewChild.attr({cx:t.x,cy:t.y,r:e.width/2})},updateConnectionPreview:function(t,e,i){this.svgPreviewConnection.attr({d:d.connectors.rounded(t,e,i,{})})},findDirection:function(t,e){var i,n=t.root.get("layout")||t.getType();switch(n){case"BL-BR":case"TL-TR":case"L-R":return i=n.split("-"),e.x>t.rootCX?i[1]:i[0];case"BL-TL":case"BR-TR":case"B-T":return i=n.split("-"),e.y>t.rootCY?i[0]:i[1];case"L":case"R":case"T":case"B":case"TR":case"TL":case"BR":case"BL":return n;default:return t.direction}},isConnectionValid:function(t,e,i){var n=e.parentArea.root;if(t.id==n.id)return!1;if(this.model.graph.isSuccessor(t,e.parentArea.root))return!1;var o=this.model.getLayoutArea(t);if(o.parentArea&&o.parentArea==e.parentArea&&o.direction==e.direction){var s=o.siblingRank-i;if(0==s||1==s)return!1}var r=this.options.validateConnection;return"function"!=typeof r||r.call(this,t,n,this)},canInteract:function(e){return function(t){this.options.canInteract(t)&&e.apply(this,arguments)}.bind(this)},startDragging:function(t){var e=Array.isArray(t)?t:[t];d.util.isEmpty(e)||this.delegateDocumentEvents(null,{moveCounter:0,draggedElements:e})},onPointerdown:function(t){this.startDragging(t.model)},onPointermove:function(t){var e=t.data,i=this.options.paper,n=i.clientToLocalPoint({x:t.clientX,y:t.clientY});e.moveCounter===i.options.clickThreshold?this._startDrag(e.draggedElements,n.x,n.y):e.moveCounter>i.options.clickThreshold&&this._doDrag(e.draggedElements,n.x,n.y),e.moveCounter++},onPointerup:function(t){var e=t.data,i=this.options.paper;if(e.moveCounter>=i.options.clickThreshold){var n=i.clientToLocalPoint({x:t.clientX,y:t.clientY});this._finishDrag(e.draggedElements,n.x,n.y)}this.undelegateDocumentEvents()}});t.TreeLayoutView=e}(this.joint.ui=this.joint.ui||{},$,joint);