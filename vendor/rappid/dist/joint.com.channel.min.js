/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,e,n){"use strict";if(e=e&&e.hasOwnProperty("default")?e.default:e,"undefined"!=typeof module&&module.exports)var i=require("ws").Server,s=require("ws"),h=require("url");s=s||"undefined"!=typeof window&&window.WebSocket;function r(t){if(this.options=t,!this.options||!this.options.graph)throw new Error("Channel: missing a graph.");this.options.ttl=this.options.ttl||60,this.options.healthCheckInterval=this.options.healthCheckInterval||36e5,this.options.reconnectInterval=this.options.reconnectInterval||1e4,this.options.serverShouldSendGraph=void 0===this.options.serverShouldSendGraph||this.options.serverShouldSendGraph,this._isClient=!!this.options.url,this._clients=[],this.messageQueue=[],this.id=this.options.id||(this._isClient?"c_":"s_")+n.util.uuid(),this.state={},this.state[this.id]=0,this.sites={},this.sites[this.id]={socket:void 0,outgoing:[],ttl:this.options.ttl},this.initialize()}n.util.assign(r.prototype,e.Events),r.prototype.initialize=function(){this.options.graph.on("all",this.onGraphChange.bind(this)),this._isClient?this.connectClient():this.options.port&&(this.server=new i({port:this.options.port}),this.server.on("connection",this.onConnection.bind(this))),this._isClient||(this._healthCheckInterval=setInterval(this.healthCheck.bind(this),this.options.healthCheckInterval))},r.prototype.connectClient=function(){var t=this.options.url+"/?channelId="+this.id+"&state="+JSON.stringify(this.state)+(this.options.query?"&query="+JSON.stringify(this.options.query):"");0<this.options.debugLevel&&this.log("connectClient",t);var e=new s(t);e.onopen=this.onConnection.bind(this,e),e.onclose=this.onClose.bind(this,e)},r.prototype.close=function(){this._reconnectTimeout&&clearTimeout(this._reconnectTimeout),this._healthCheckInterval&&clearInterval(this._healthCheckInterval),this._closed=!0,n.util.forIn(this.sites,function(t){t.socket&&t.socket.close()}),this.server&&this.server.close()},r.prototype.healthCheck=function(){if(0<this.options.debugLevel){var t=Object.keys(this.sites).reduce(function(t,e){return t[e]=this[e].ttl,t}.bind(this.sites),{});this.log("healthCheck",t)}n.util.forIn(this.sites,function(t,e){e!==this.id&&(t.socket&&1===t.socket.readyState?t.ttl=this.options.ttl:t.ttl-=1,t.ttl<=0&&(this.sites=n.util.omit(this.sites,e),this.state=n.util.omit(this.state,e)))}.bind(this))},r.prototype.onConnection=function(e,t){if(this._clients.push(e),this.trigger("open",e),this._isClient)(this.sites[this.id].socket=e).onmessage=function(t){this.onMessage(e,t.data)}.bind(this);else{var i=e.upgradeReq||t,s=h.parse(i.url,!0).query.channelId;if(this.sites[s])this.sites[s].socket=e;else if(1<this.debugLevel&&this.log("new_site",s),this.sites[s]={socket:e,outgoing:[],ttl:this.options.ttl},this.state[s]=0,this.options.serverShouldSendGraph){var o={channelId:this.id,state:JSON.parse(JSON.stringify(this.state)),action:"graph",graph:this.options.graph.toJSON()};this.messageQueue.push({type:"op",data:o,source:this.id,target:[s]}),this.send()}e.on("message",this.onMessage.bind(this,e)),e.on("close",this.onClose.bind(this,e))}},r.prototype.onClose=function(t){var e=this._clients.indexOf(t);-1!==e&&this._clients.splice(e,1),this._isClient&&!this._closed&&(this._reconnectTimeout&&clearTimeout(this._reconnectTimeout),this._reconnectTimeout=setTimeout(this.connectClient.bind(this),this.options.reconnectInterval)),this.trigger("close",t)},r.prototype.onMessage=function(t,e){this.trigger("message:received",e),1<this.options.debugLevel&&this.log("message",e);try{e=JSON.parse(e)}catch(t){return console.error("Channel: message parsing failed.",t)}if("notification"==e.type)return this.trigger(e.data.event,e.data.data),this.sendNotification(e);var i,s,o=e.data;"graph"===(o=(i=(this._isClient||(s=this.sites[o.channelId],o=this.receive(s,o.channelId,o)),this.sites[this.id]),this.receive(i,this.id,o))).action?this.state[o.channelId]=o.state[o.channelId]:this.state[o.channelId]=(this.state[o.channelId]||0)+1,1<this.options.debugLevel&&this.log("new state",this.state),this.execute(o),n.util.forIn(this.sites,function(t,e){e!==this.id&&e!==o.channelId&&this.receive(t,e,o)}.bind(this)),this._isClient||(e.op=o,this.messageQueue.push(e),this.broadcast(e)),this.trigger("message:processed",e)},r.prototype.receive=function(t,e,i){if(!t)return i;1<this.options.debugLevel&&this.log("receive",e,i),1<this.options.debugLevel&&this.log("outgoing",t.outgoing),t.outgoing=t.outgoing.filter(function(t){return t.state[t.channelId]>=(i.state[t.channelId]||0)}),1<this.options.debugLevel&&this.log("outgoing.length",t.outgoing.length);for(var s=0;s<t.outgoing.length;s++){var o=t.outgoing[s],n=this.transform(i,o);i=n[0],t.outgoing[s]=n[1]}return i},r.prototype.transform=function(t,e){return 1<this.options.debugLevel&&this.log("transform",t,e),"change:target"===t.action&&"remove"===e.action&&t.cell.target.id===e.cell.id&&(t.cell.target={x:0,y:0}),"change:source"===t.action&&"remove"===e.action&&t.cell.source.id===e.cell.id&&(t.cell.source={x:0,y:0}),[t,e]},r.prototype.execute=function(t){var e;switch(t.action){case"add":this.options.graph.addCell(t.cell,{remote:!0});break;case"remove":(e=this.options.graph.getCell(t.cell.id))&&e.remove({remote:!0,disconnectLinks:!0});break;case"graph":this.options.graph.fromJSON(t.graph);break;default:var i=t.action.substr("change:".length);(e=this.options.graph.getCell(t.cell.id))&&e.set(i,t.cell[i],{remote:!0})}},r.prototype.broadcast=function(t){this._isClient?t.target=Object.keys(this.sites):t.target=Object.keys(n.util.omit(this.sites,this.id,t.source)),this.send()},r.prototype.send=function(){if(!this._paused){for(var t=[],e=0;e<this.messageQueue.length;e++){var i=this.messageQueue[e];this.sendMessage(i)&&t.push(e)}t.forEach(function(t){this.messageQueue.splice(t,1)},this)}},r.prototype.sendMessage=function(s){1<this.debugLevel&&this.log("sendMessage",s);var o=[];return s.target.forEach(function(t,e){var i=this.sites[t];if(!i)return o.push(e);i.socket&&1===i.socket.readyState&&(1<this.debugLevel&&this.log("sendMessage",t,s),i.socket.send(JSON.stringify(s)),o.push(e))},this),o.forEach(function(t){s.target.splice(t,1)}),!s.target.length},r.prototype.log=function(t,e){var i="Channel ["+this.id+"] "+t.toUpperCase()+": ";console.log.apply(console,[i].concat(Array.prototype.slice.call(arguments,1)))},r.prototype.pause=function(){this._paused=!0},r.prototype.unpause=function(){this._paused=!1,this.send()},r.prototype.notify=function(t,e){var i={type:"notification",source:this.id,data:{event:t,data:e}};this.sendNotification(i)},r.prototype.sendNotification=function(t){this._isClient?t.target=Object.keys(this.sites):t.target=Object.keys(n.util.omit(this.sites,this.id,t.source)),this.sendMessage(t)},r.prototype.onGraphChange=function(t,e,i,s){if((!s||!s.remote)&&("add"===t||"remove"===t||"change:"===t.substr(0,"change:".length))){var o={channelId:this.id,state:JSON.parse(JSON.stringify(this.state)),action:t,cell:e.toJSON()},n={type:"op",data:o,source:this.id};1<this.options.debugLevel&&this.log("generate",n),this.messageQueue.push(n),this.broadcast(n),this.sites[this.id].outgoing.push(o),this.state[this.id]++}};function o(t){if(this.options=t,!this.options.port)throw new Error("ChannelHub: missing a port.");this.initialize()}n.util.assign(o.prototype,e.Events),o.prototype.initialize=function(){this.server=new i({port:this.options.port}),this.server.on("connection",this.onConnection.bind(this))},o.prototype.onConnection=function(i,s){var t=i.upgradeReq||s,e={query:h.parse(t.url,!0).query};if(!this.router)throw new Error("ChannelHub: missing a router.");var o=!1,n=this.router(e,function(t,e){if(t)throw new Error(t);e&&!o&&(e.onConnection(i,s),o=!0)});n instanceof r&&(n.onConnection(i,s),o=!0)},o.prototype.route=function(t){this.router=t},o.prototype.close=function(){this.server.close()},t.Channel=r,t.ChannelHub=o}(this.joint.com=this.joint.com||{},Backbone,joint);