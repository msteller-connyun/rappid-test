/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,D){"use strict";var e=D.dia.Element,n=D.dia.ElementView.prototype,i=e.define("standard.Record",{size:{width:100},padding:0,items:[],itemHeight:20,itemOffset:20,itemMinLabelWidth:10,itemButtonSize:10,itemIcon:{width:16,height:16,padding:2},itemOverflow:!1,attrs:{bodiesGroups:{fill:"transparent",stroke:"none"},labelsGroups:{fill:"#333333"},buttonsGroups:{fill:"transparent",stroke:"#333333",strokeWidth:1},forksGroups:{stroke:"#333333"},groups:{groupPosition:!0},itemBodies:{groupWidth:!0,itemHighlight:{fill:"#eeeeee"}},itemLabels:{fontSize:16,textVerticalAnchor:"middle",pointerEvents:"bounding-box",itemText:{textWrap:!0,ellipsis:!0},itemHighlight:{fill:"red"}}}},{markup:[],metrics:null,markupAttributes:["items","itemHeight","itemOffset","itemIcon","itemMinLabelWidth","itemButtonSize","itemOverflow","padding"],initialize:function(){D.dia.Element.prototype.initialize.apply(this,arguments),this.on("change",this.onChange,this),this.buildMarkup()},anyHasChanged:function(t){return!!Array.isArray(t)&&t.some(function(t){return this.hasChanged(t)},this)},onChange:function(t,e){e.record!==this.id&&this.hasChanged("markup")&&T("Markup can not be modified."),this.anyHasChanged(this.markupAttributes)&&this.buildMarkup(e)},buildMarkup:function(t){var e=this.metrics={},i=e.items={},r=this.attributes,n=r.itemHeight,a=r.itemOffset,s=!!r.itemOverflow,o=r.items;Array.isArray(o)||(o=[]);var h=o.length,u=0,l=D.util.cloneDeep(this.markup);Array.isArray(l)||T("Expects Prototype JSON Markup.");for(var d=D.util.normalizeSides(r.padding),p=0,g=0;g<h;g++){for(var c=[],m=[],f=[],b=[],v=[],I=Array.from(o[g]),y=this.createQueue(I,0,[],null),A=0,k=0;0<y.length;){var x=y.pop(),S=x.path,w=x.level,M=x.item,P=x.parent;0===w&&S.splice(1,0,g);var C=M.id,N=-1!==w,B=M.height||n,G=M.icon,H=M.items,O=!!M.highlighted,F=!!M.collapsed,L=Array.isArray(H)&&0<H.length;C||T("Item id required."),i.hasOwnProperty(C)&&T("Duplicated item id.");var z=i[C]={path:S,visible:N,parent:P,label:M.label,height:B,group:g,hasSubItems:L,highlighted:O,collapsed:F};if(L&&(z.children=H.map(function(t){return t.id}),Array.prototype.push.apply(y,this.createQueue(H,F||!N?-1:w+1,S,C))),N){var W=a*w;if(z.x=W+a,z.y=A,z.cx=W+a/2,z.cy=A+B/2,z.span=M.span||1,C){var E=this.getItemBodyMarkup(M,W,A,g,s&&0===g?d.left:0);c.push(E);var R=this.getItemLabelMarkup(M,W,A,g);m.push(R),L&&(f.push(this.getButtonMarkup(M,W,A,g)),F||v.push(C)),G&&(b.push(this.getIconMarkup(M,W,A,g)),z.x+=r.itemIcon.width+r.itemIcon.padding)}k=Math.max(k,z.x+r.itemMinLabelWidth),A+=B}}p=Math.max(k,p),u=Math.max(u,A);var j=[];l.push({tagName:"g",selector:this.getSelector("group",g),groupSelector:"groups",attributes:{"record-group":g},children:j}),j.push({tagName:"g",selector:this.getSelector("bodiesGroup",g),groupSelector:"bodiesGroups",children:c},{tagName:"g",selector:this.getSelector("labelsGroup",g),groupSelector:"labelsGroups",children:m}),0<v.length&&j.push({tagName:"g",selector:this.getSelector("forksGroup",g),groupSelector:"forksGroups",children:v.map(this.getForkMarkup,this)}),0<f.length&&j.push({tagName:"g",selector:this.getSelector("buttonsGroup",g),groupSelector:"buttonsGroups",children:f}),0<b.length&&j.push({tagName:"g",selector:this.getSelector("iconsGroup",g),groupSelector:"iconsGroups",children:b})}e.padding=d,e.groupsCount=h,e.overflow=s,e.minHeight=u+d.top+d.bottom,e.minWidth=p*h+d.left+d.right;var V=D.util.assign({record:this.id},t);this.set("markup",l,V),this.autoresize(V)},autoresize:function(t){var e=this.getMinimalSize(),i=this.attributes.size.width;this.resize(Math.max(i,e.width),e.height,t)},getMinimalSize:function(){var t=this.metrics;return{width:t.minWidth,height:t.minHeight}},removeInvalidLinks:function(e){var t=this.graph;return t?t.getConnectedLinks(this).filter(this.isLinkInvalid,this).map(function(t){return t.remove(e)}):[]},isLinkInvalid:function(t){var e=this.id,i=this.metrics.items,r=t.source();if(r.id===e&&r.hasOwnProperty("port")&&!i[r.port])return!0;var n=t.target();return!(n.id!==e||!n.hasOwnProperty("port")||i[n.port])},createQueue:function(r,n,a,s){var o=r.length;return Array.from({length:o},function(t,e){var i=o-e-1;return{path:a.concat(["items",i]),item:r[i],level:n,parent:s}})},getGroupSelector:function(t){for(var e=Array.prototype.slice.call(arguments,1),i=[t],r=0,n=e.length;r<n;r++){var a=e[r];if(null!=a){Array.isArray(a)||(a=[a]);for(var s=0,o=a.length;s<o;s++)i.push(this.getSelector(t,a[s]))}}return i},getItemLabelMarkup:function(t,e,i,r){var n=this.attributes,a=n.itemOffset,s=t.height||n.itemHeight,o=t.id,h=e+a;return t.icon&&(h+=n.itemIcon.width+2*n.itemIcon.padding),{tagName:"text",className:"record-item-label",selector:this.getSelector("itemLabel",o),groupSelector:this.getGroupSelector("itemLabels",r,t.group),attributes:{x:h,y:i+s/2,"item-id":o}}},getItemBodyMarkup:function(t,e,i,r,n){var a=0;n&&(a-=n);var s={x:a,y:i,height:t.height||this.attributes.itemHeight,"item-id":t.id},o=t.span;return o&&(s["item-span"]=o),{tagName:"rect",selector:this.getSelector("itemBody",t.id),groupSelector:this.getGroupSelector("itemBodies",r,t.group),className:"record-item-body",attributes:s}},getButtonMarkup:function(t,e,i){var r=this.attributes,n=r.itemButtonSize,a=r.itemOffset,s=t.height||r.itemHeight;return{tagName:"path",className:"record-item-button",attributes:{d:this.getButtonPathData(e+a/2,i+s/2,n/2,t.collapsed),"item-id":t.id,cursor:"pointer","shape-rendering":"geometricprecision"}}},getIconMarkup:function(t,e,i){var r=this.attributes,n=r.itemOffset,a=r.itemIcon,s=t.height||r.itemHeight;return{tagName:"image",className:"record-item-icon",attributes:{x:e+n+a.padding,y:i+(s-a.height)/2,width:a.width,height:a.height,"xlink:href":t.icon}}},getForkMarkup:function(t){return{tagName:"path",attributes:{d:this.getForkPathData(t),fill:"none"}}},getButtonPathData:function(t,e,i,r){var n=["M",t-i,e-i,t+i,e-i,t+i,e+i,t-i,e+i,"Z","M",t-i/2,e,t+i/2,e];return r&&Array.prototype.push.apply(n,["M",t,e-i/2,t,e+i/2]),n.join(" ")},getForkPathData:function(t){var e=this.metrics.items;if(!e)return null;var i=e[t];if(!i)return null;var r=i.children;if(!r||0===r.length)return null;for(var n,a=this.attributes.itemButtonSize,s=[],o=0,h=r.length;o<h;o++){var u=(n=e[r[o]]).cx+(n.hasSubItems?-1:1)*a/2;s.push("M",i.cx,n.cy,u,n.cy)}return s.push("M",i.cx,i.cy+a/2,i.cx,n.cy),s.join(" ")},item:function(t,e,i){var r=this.getItemPathArray(t);return r?void 0===e?this.prop(r):this.prop(r,e,i):null},toggleItemCollapse:function(t,e){var i=this.getItemPathArray(t);if(!i)return this;i.push("collapsed");var r=!!this.prop(i);return this.prop(i,!r,e),this},toggleItemHighlight:function(t,e){var i=this.getItemPathArray(t);if(!i)return this;i.push("highlighted");var r=!!this.prop(i);return this.prop(i,!r,e),this},isItemVisible:function(t){return this.getItemCacheAttribute(t,"visible")},isItemCollapsed:function(t){return this.getItemCacheAttribute(t,"collapsed")},isItemHighlighted:function(t){return this.getItemCacheAttribute(t,"highlighted")},getItemParentId:function(t){return this.getItemCacheAttribute(t,"parent")},getItemGroupIndex:function(t){return this.getItemCacheAttribute(t,"group")},getItemPathArray:function(t){var e=this.getItemCacheAttribute(t,"path");return e?e.slice():null},getItemSide:function(t){var e=this.getItemGroupIndex(t);if(null===e)return null;var i=this.metrics,r=i.groupsCount;if(1<r){if(0===e)return"left";if(e+i.items[t].span-1==r-1)return"right"}return"middle"},getItemCacheAttribute:function(t,e){if(!e)return null;var i=this.metrics.items;if(!i)return null;var r=i[t];return r?r[e]:null},getSelector:function(t,e){return t+"_"+e},removeItem:function(t,e){var i=this.getItemPathArray(t);if(!i)return this;var r=i.pop(),n=this.prop(i).slice();return 1<n.length?(n.splice(r,1),this.prop(i,n,D.util.assign({rewrite:!0},e))):2<i.length?this.removeProp(i,e):(r=i.pop(),(n=this.get("items").slice()).splice(r,1),this.prop(i,n,D.util.assign({rewrite:!0},e))),this},addNextSibling:function(t,e,i){var r=this.getItemPathArray(t);if(!r)return this;var n=this.getItemParentId(t)||this.getItemGroupIndex(t),a=r[r.length-1]+1;return this.addItemAtIndex(n,a,e,i)},addPrevSibling:function(t,e,i){var r=this.getItemPathArray(t);if(!r)return this;var n=this.getItemParentId(t)||this.getItemGroupIndex(t),a=r[r.length-1];return this.addItemAtIndex(n,a,e,i)},addItemAtIndex:function(t,e,i,r){if(!i)return this;var n;switch(typeof t){case"number":var a=this.prop("items");n=["items",Math.min(Math.max(t,0),a.length)];break;case"string":if(!(n=this.getItemPathArray(t)))return this;n.push("items");break;default:T("Requires an item id.")}var s=this.prop(n);s=Array.isArray(s)?s.slice():[];var o=Math.min(Math.max(e,0),s.length);return s.splice(o,0,i),this.prop(n,s,D.util.assign({rewrite:!0},r))},toJSON:function(){var t=D.dia.Element.prototype.toJSON.apply(this,arguments);return delete t.markup,t}},{attributes:{itemText:{set:function(t,e,i,r){if(!D.util.isPlainObject(t))return null;var n=this.model,a=i.getAttribute("item-id"),s=n.metrics.items[a];if(s){var o,h,u=s.label,l=n.metrics.padding,d=n.metrics.groupsCount,p=s.x,g=(e.width-l.left-l.right)/d*s.span-p,c=new D.g.Rect(p,s.y,g,s.height);h=t.textWrap?(o="textWrap",{text:u,ellipsis:t.ellipsis}):(o="text",u),this.getAttributeDefinition(o).set.call(this,h,c,i,r)}}},itemHighlight:{set:function(t,e,i,r){if(!D.util.isPlainObject(t))return null;var n=this.model,a=i.getAttribute("item-id");switch(n.getItemCacheAttribute(a,"highlighted")){case!0:return t;case null:case!1:return Object.keys(t).reduce(function(t,e){return!(r.hasOwnProperty(e)||r.hasOwnProperty(D.util.camelCase(e)))&&i.getAttribute(e)&&(t[e]=null),t},{})}}},groupWidth:{set:function(t,e,i){var r=this.model.metrics,n=r.padding,a=r.groupsCount,s=(e.width-n.left-n.right)/a,o=i.getAttribute("item-span");if(o&&(s*=Number(o)),r.overflow){var h=Number(this.findAttribute("record-group",i));0===h&&(s+=n.left),h===a-1&&(s+=n.right)}return{width:s}}},groupPosition:{position:function(t,e,i){var r=Number(i.getAttribute("record-group")),n=this.model.metrics,a=n.groupsCount,s=n.padding,o=(e.width-s.left-s.right)/a,h=s.left+r*o,u=s.top;return new D.g.Point(h,u)}}}}),r=i.define("standard.BorderedRecord",{padding:0,attrs:{body:{refWidth:"100%",refHeight:"100%",stroke:"#000000",fill:"#FFFFFF"}}},{markup:[{tagName:"rect",selector:"body"}]}),a=i.define("standard.HeaderedRecord",{padding:{top:30,left:0,right:0,bottom:0},attrs:{body:{refWidth:"100%",refHeight:"100%",stroke:"#000000",fill:"#FFFFFF"},header:{refWidth:"100%",height:30,stroke:"#000000",fill:"transparent"},headerLabel:{refX:"50%",refY:15,textAnchor:"middle",textVerticalAnchor:"middle",fontSize:20,fill:"#333333"}}},{markup:[{tagName:"rect",selector:"body"},{tagName:"rect",selector:"header"},{tagName:"text",selector:"headerLabel"}]}),s=i.prototype.markupAttributes.reduce(function(t,e){return t[e]=["UPDATE"],t},{}),o=D.dia.ElementView.extend({events:{"mousedown .record-item-button":"onItemButtonClick","touchstart .record-item-button":"onItemButtonClick"},presentationAttributes:D.dia.ElementView.addPresentationAttributes(s),getLinkEnd:function(t){return{id:this.model.id,port:this.findAttribute("item-id",t)}},getMagnetFromLinkEnd:function(t){for(var e=t.port,i=this.model;e&&!i.isItemVisible(e);)e=i.getItemParentId(e);e||n.getMagnetFromLinkEnd.apply(this,arguments);var r=i.getSelector("itemBody",e);return this.findBySelector(r,this.el,this.selectors)[0]},onItemButtonClick:function(t){t.stopPropagation(),t.preventDefault();var e=t.currentTarget.getAttribute("item-id");this.model.toggleItemCollapse(e,{ui:!0})}}),h=o,u=o;function T(t){throw new Error("shapes.standard.Record: "+t)}t.BorderedRecord=r,t.BorderedRecordView=h,t.HeaderedRecord=a,t.HeaderedRecordView=u,t.Record=i,t.RecordView=o}(this.joint.shapes=this.joint.shapes||{},joint);