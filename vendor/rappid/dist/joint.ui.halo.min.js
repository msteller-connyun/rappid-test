/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,v,w){"use strict";v=v&&v.hasOwnProperty("default")?v.default:v;function a(){this.options={handles:[{name:"remove",position:"nw",events:{pointerdown:"removeElement"},icon:null},{name:"direction",position:"se",events:{pointerdown:"directionSwap"},icon:null}],bbox:function(t){var e=.5*t.getConnectionLength();return t.getPointAtLength(e)},typeCssName:"type-link",tinyThreshold:-1,smallThreshold:-1,boxContent:!1}}a.prototype.directionSwap=function(){var t=this.options.cellView.model;t.set({source:t.get("target"),target:t.get("source")},{halo:this.cid})};function r(){this.options={handles:[{name:"remove",position:"nw",events:{pointerdown:"removeElement"},icon:null},{name:"resize",position:"se",events:{pointerdown:"startResizing",pointermove:"doResize",pointerup:"stopBatch"},icon:null},{name:"clone",position:"n",events:{pointerdown:"startCloning",pointermove:"doClone",pointerup:"stopCloning"},icon:null},{name:"link",position:"e",events:{pointerdown:"startLinking",pointermove:"doLink",pointerup:"stopLinking"},icon:null},{name:"fork",position:"ne",events:{pointerdown:"startForking",pointermove:"doFork",pointerup:"stopForking"},icon:null},{name:"unlink",position:"w",events:{pointerdown:"unlinkElement"},icon:null},{name:"rotate",position:"sw",events:{pointerdown:"startRotating",pointermove:"doRotate",pointerup:"stopBatch"},icon:null}],bbox:function(t,e){return t.getBBox({useModelGeometry:e.options.useModelGeometry})},typeCssName:"type-element",tinyThreshold:40,smallThreshold:80,boxContent:function(t,e){var i=w.util.template("x: <%= x %>, y: <%= y %>, width: <%= width %>, height: <%= height %>, angle: <%= angle %>"),n=t.model,o=n.getBBox();return i({x:Math.floor(o.x),y:Math.floor(o.y),width:Math.floor(o.width),height:Math.floor(o.height),angle:Math.floor(n.get("angle")||0)})},magnet:function(t){return t.el},loopLinkPreferredSide:"top",loopLinkWidth:40,rotateAngleGrid:15,rotateEmbeds:!1,linkAttributes:{},smoothLinks:void 0}}r.prototype.startLinking=function(t,e,i){this.startBatch();var n=this.options,o=n.paper,s=n.graph,a=this.createLinkConnectedToSource();a.set({target:{x:e,y:i}}).addTo(s,{validation:!1,halo:this.cid,async:!1}),o.undelegateEvents(),(this._linkView=a.findView(o)).startArrowheadMove("target",{whenNotAllowed:"remove"})},r.prototype.startForking=function(t,e,i){var n=this.options,o=n.paper,s=n.graph;this.startBatch();var a=n.clone(n.cellView.model,{fork:!0});if(!(a instanceof w.dia.Cell))throw new Error('ui.Halo: option "clone" has to return a cell.');this.centerElementAtCursor(a,e,i),a.addTo(s,{halo:this.cid,async:!1});var r=this.createLinkConnectedToSource(),l=a.findView(o),h=this.getElementMagnet(l,"target"),p=this.getLinkEnd(l,h);r.set("target",p).addTo(s,{halo:this.cid,async:!1}),l.pointerdown(t,e,i),this.eventData(t,{cloneView:l})},r.prototype.getElementMagnet=function(t,e){var i=this.options.magnet;if(w.util.isFunction(i)){var n=i.call(this,t,e);if(n instanceof SVGElement)return n}throw new Error("ui.Halo: magnet() has to return an SVGElement.")},r.prototype.getLinkEnd=function(t,e){var i={id:t.model.id};if(e!==t.el){var n=e.getAttribute("port");n?i.port=n:i.selector=t.getSelector(e)}return i},r.prototype.createLinkConnectedToSource=function(){var t=this.options,e=t.paper,i=t.cellView,n=this.getElementMagnet(i,"source"),o=this.getLinkEnd(i,n),s=e.getDefaultLink(i,n).set("source",o);return s.attr(t.linkAttributes),w.util.isBoolean(t.smoothLinks)&&s.set("smooth",t.smoothLinks),s},r.prototype.startResizing=function(t){this.startBatch(),this._flip=[1,0,0,1,1,0,0,1][Math.floor(w.g.normalizeAngle(this.options.cellView.model.get("angle"))/45)]},r.prototype.startRotating=function(t,e,i){this.startBatch();var n=this.options.cellView.model,o=n.getBBox().center(),s=[n];this.options.rotateEmbeds&&n.getEmbeddedCells({deep:!0}).reduce(function(t,e){return e.isElement()&&t.push(e),t},s),this.eventData(t,{center:o,elements:s,rotationStartAngles:s.map(function(t){return t.angle()}),clientStartAngle:new w.g.Point(e,i).theta(o)})},r.prototype.doResize=function(t,e,i,n,o){var s=this.options.cellView.model.get("size"),a=Math.max(s.width+(this._flip?n:o),1),r=Math.max(s.height+(this._flip?o:n),1);this.options.cellView.model.resize(a,r,{absolute:!0})},r.prototype.doRotate=function(t,e,i){var o=this.eventData(t),s=o.clientStartAngle-new w.g.Point(e,i).theta(o.center);o.elements.forEach(function(t,e){var i=o.rotationStartAngles[e],n=w.g.snapToGrid(i+s,this.options.rotateAngleGrid);t.rotate(n,!0,o.center,{halo:this.cid})},this)},r.prototype.doClone=function(t,e,i){var n=this.eventData(t).cloneView;n&&n.pointermove(t,e,i)},r.prototype.startCloning=function(t,e,i){var n=this.options;this.startBatch();var o=n.clone(n.cellView.model,{clone:!0});if(!(o instanceof w.dia.Cell))throw new Error('ui.Halo: option "clone" has to return a cell.');this.centerElementAtCursor(o,e,i),o.addTo(n.graph,{halo:this.cid,async:!1});var s=o.findView(n.paper);s.pointerdown(t,e,i),this.eventData(t,{cloneView:s})},r.prototype.centerElementAtCursor=function(t,e,i){var n=t.getBBox().center(),o=e-n.x,s=i-n.y;t.translate(o,s)},r.prototype.doFork=function(t,e,i){var n=this.eventData(t).cloneView;n&&n.pointermove(t,e,i)},r.prototype.doLink=function(t,e,i){this._linkView&&this._linkView.pointermove(t,e,i)},r.prototype.stopLinking=function(t,e,i){var n=this._linkView;if(n){n.pointerup(t,e,i);var o=n.model;o.hasLoop()&&this.makeLoopLink(o),this.stopBatch(),this.triggerAction("link","add",o),this._linkView=null}this.options.paper.delegateEvents()},r.prototype.stopForking=function(t,e,i){var n=this.eventData(t).cloneView;n&&n.pointerup(t,e,i),this.stopBatch()},r.prototype.stopCloning=function(t,e,i){var n=this.eventData(t).cloneView;n&&n.pointerup(t,e,i),this.stopBatch()},r.prototype.unlinkElement=function(t){this.startBatch(),this.options.graph.removeLinks(this.options.cellView.model),this.stopBatch()},r.prototype.makeLoopLink=function(t){var o,s,a=this.options.loopLinkWidth,e=this.options.paper.options,r=w.g.rect({x:0,y:0,width:e.width,height:e.height}),l=this.options.paper.paperToLocalRect(this.options.cellView.getBBox());w.util.uniq([this.options.loopLinkPreferredSide,"top","bottom","left","right"]).find(function(t){var e,i=0,n=0;switch(t){case"top":e=w.g.point(l.x+l.width/2,l.y-a),i=a/2;break;case"bottom":e=w.g.point(l.x+l.width/2,l.y+l.height+a),i=a/2;break;case"left":e=w.g.point(l.x-a,l.y+l.height/2),n=a/2;break;case"right":e=w.g.point(l.x+l.width+a,l.y+l.height/2),n=a/2}return o=w.g.point(e).offset(-i,-n),s=w.g.point(e).offset(i,n),r.containsPoint(o)&&r.containsPoint(s)},this)&&t.set("vertices",[o,s])};var e=w.mvc.View.extend({PIE_INNER_RADIUS:20,PIE_OUTER_RADIUS:50,className:"halo",events:{"mousedown .handle":"onHandlePointerDown","touchstart .handle":"onHandlePointerDown","mousedown .pie-toggle":"onPieTogglePointerDown","touchstart .pie-toggle":"onPieTogglePointerDown"},documentEvents:{mousemove:"pointermove",touchmove:"pointermove",mouseup:"pointerup",touchend:"pointerup"},options:{clearAll:!0,clearOnBlankPointerdown:!0,useModelGeometry:!1,clone:function(t,e){return t.clone().unset("z")},type:"surrounding",pieSliceAngle:45,pieStartAngleOffset:0,pieIconSize:14,pieToggles:[{name:"default",position:"e"}]},init:function(){var t=this.options,e=t.cellView,i=e.model,n=i.isLink()?new a:new r;w.util.assign(this,w.util.omit(n,"options"));var o=e.paper,s=o.model;w.util.defaults(t,n.options,{paper:o,graph:s}),w.util.bindAll(this,"render","update"),t.clearAll&&this.constructor.clear(o),this.listenTo(s,"reset",this.remove),this.listenTo(i,"remove",this.remove),this.listenTo(o,"halo:create",this.remove),t.clearOnBlankPointerdown&&this.listenTo(o,"blank:pointerdown",this.remove),this.listenTo(s,"all",this.update),this.listenTo(o,"scale translate",this.update),this.handles=[],w.util.toArray(t.handles).forEach(this.addHandle,this)},render:function(){var t=this.options;switch(this.$el.empty(),this.$handles=v("<div/>").addClass("handles").appendTo(this.el),this.$box=v("<label/>").addClass("box").appendTo(this.el),this.$pieToggles={},this.$el.addClass(t.type),this.$el.addClass(this.cellTypeCssClass()),this.$el.attr("data-type",t.cellView.model.get("type")),this.$handles.append(w.util.toArray(this.handles).map(this.renderHandle,this)),t.type){case"toolbar":case"surrounding":this.hasHandle("fork")&&this.toggleFork();break;case"pie":w.util.toArray(this.options.pieToggles).forEach(function(t){var e=v("<div/>");e.addClass("pie-toggle "+(t.position||"e")),e.attr("data-name",t.name),w.util.setAttributesBySelector(e,t.attrs),e.appendTo(this.el),this.$pieToggles[t.name]=e},this);break;default:throw new Error("ui.Halo: unknown type")}return this.update(),this.$el.addClass("animate").appendTo(t.paper.el),this.setPieIcons(),this},setPieIcons:function(){"pie"===this.options.type&&this.$el.find(".handle").each(function(t,e){var i,n=v(e),o=n.attr("data-action"),s=this.getHandle(o);if(!s||!s.icon){var a=window.getComputedStyle(e,":before").getPropertyValue("content");a&&"none"!==a&&0<(i=n.find(".slice-text-icon")).length&&w.V(i[0]).text(a.replace(/['"]/g,""));var r=n.css("background-image");if(r){var l=r.match(/url\(['"]?([^'"]+)['"]?\)/);if(l){var h=l[1];0<(i=n.find(".slice-img-icon")).length&&w.V(i[0]).attr("xlink:href",h)}}}}.bind(this))},update:function(){if(this.isRendered()){this.updateBoxContent();var t=this.getBBox();this.$el.toggleClass("tiny",t.width<this.options.tinyThreshold&&t.height<this.options.tinyThreshold),this.$el.toggleClass("small",!this.$el.hasClass("tiny")&&t.width<this.options.smallThreshold&&t.height<this.options.smallThreshold),this.$el.css({width:t.width,height:t.height,left:t.x,top:t.y}),this.hasHandle("unlink")&&this.toggleUnlink()}},getBBox:function(){var t=this.options.cellView,e=this.options.bbox,i=w.util.isFunction(e)?e(t,this):e;return i=w.util.defaults({},i,{x:0,y:0,width:1,height:1}),w.g.rect(i)},cellTypeCssClass:function(){return this.options.typeCssName},updateBoxContent:function(){var t=this.options.boxContent,e=this.options.cellView;if(w.util.isFunction(t)){var i=t.call(this,e,this.$box[0]);i&&this.$box.html(i)}else t?this.$box.html(t):this.$box.remove()},extendHandles:function(t){w.util.forIn(t,function(t){var e=this.getHandle(t.name);e&&w.util.assign(e,t)}.bind(this))},addHandles:function(t){return w.util.toArray(t).forEach(this.addHandle,this),this},addHandle:function(i){return this.getHandle(i.name)||(this.handles.push(i),w.util.forIn(i.events,function(t,e){w.util.isString(t)?this.on("action:"+i.name+":"+e,this[t],this):this.on("action:"+i.name+":"+e,t)}.bind(this)),this.$handles&&this.renderHandle(i).appendTo(this.$handles)),this},renderHandle:function(t){var e=this.getHandleIdx(t.name),i=v("<div/>").addClass("handle").addClass(t.name).attr("data-action",t.name).prop("draggable",!1);switch(this.options.type){case"toolbar":case"surrounding":i.addClass(t.position),t.content&&i.html(t.content);break;case"pie":var n=this.PIE_OUTER_RADIUS,o=this.PIE_INNER_RADIUS,s=(n+o)/2,a=w.g.point(n,n),r=w.g.toRad(this.options.pieSliceAngle),l=e*r+w.g.toRad(this.options.pieStartAngleOffset),h=l+r,p=w.V.createSlicePathData(o,n,l,h),c=w.V("svg").addClass("slice-svg"),d=w.V("path").attr("d",p).translate(n,n).addClass("slice"),u=w.g.point.fromPolar(s,-l-r/2,a),g=this.options.pieIconSize,f=w.V("image").attr(u).addClass("slice-img-icon");u.y=u.y+g-2;var m=w.V("text",{"font-size":g}).attr(u).addClass("slice-text-icon");f.attr({width:g,height:g}),f.translate(-g/2,-g/2),m.translate(-g/2,-g/2),c.append([d,f,m]),i.append(c.node)}return t.icon&&this.setHandleIcon(i,t.icon),w.util.setAttributesBySelector(i,t.attrs),i},setHandleIcon:function(t,e){switch(this.options.type){case"pie":var i=t.find(".slice-img-icon");w.V(i[0]).attr("xlink:href",e);break;case"toolbar":case"surrounding":t.css("background-image","url("+e+")")}},removeHandles:function(){for(;this.handles.length;)this.removeHandle(this.handles[0].name);return this},removeHandle:function(i){var t=this.getHandleIdx(i),e=this.handles[t];return e&&(w.util.forIn(e.events,function(t,e){this.off("action:"+i+":"+e)}.bind(this)),this.$(".handle."+i).remove(),this.handles.splice(t,1)),this},changeHandle:function(t,e){var i=this.getHandle(t);return i&&(this.removeHandle(t),this.addHandle(w.util.merge({name:t},i,e))),this},hasHandle:function(t){return-1!==this.getHandleIdx(t)},getHandleIdx:function(e){return w.util.toArray(this.handles).findIndex(function(t){return t.name===e})},getHandle:function(e){return w.util.toArray(this.handles).find(function(t){return t.name===e})},toggleHandle:function(t,e){var i=this.getHandle(t);if(i){var n=this.$(".handle."+t);void 0===e&&(e=!n.hasClass("selected")),n.toggleClass("selected",e);var o=e?i.iconSelected:i.icon;o&&this.setHandleIcon(n,o)}return this},selectHandle:function(t){return this.toggleHandle(t,!0)},deselectHandle:function(t){return this.toggleHandle(t,!1)},deselectAllHandles:function(){return w.util.toArray(this.handles).forEach(function(t){this.deselectHandle(t.name)},this),this},onHandlePointerDown:function(t){var e=this._action=v(t.target).closest(".handle").attr("data-action");if(e){t.preventDefault(),t.stopPropagation(),t=w.util.normalizeEvent(t);var i=this.options.paper.snapToGrid({x:t.clientX,y:t.clientY}),n=i.x,o=i.y;this._localX=n,this._localY=o,"mousedown"===(this._evt=t).type&&2===t.button?this.triggerAction(e,"contextmenu",t,n,o):(this.triggerAction(e,"pointerdown",t,n,o),this.delegateDocumentEvents(null,t.data))}},onPieTogglePointerDown:function(t){t.stopPropagation();var e=v(t.target).closest(".pie-toggle").attr("data-name");this.isOpen(e)||this.isOpen()&&this.toggleState(),this.toggleState(e)},triggerAction:function(t,e,i){var n=Array.prototype.slice.call(arguments,2);n.unshift("action:"+t+":"+e),this.trigger.apply(this,n)},stopBatch:function(){this.options.graph.stopBatch("halo",{halo:this.cid})},startBatch:function(){this.options.graph.startBatch("halo",{halo:this.cid})},pointermove:function(t){if(this._action){t.preventDefault(),t.stopPropagation(),t=w.util.normalizeEvent(t);var e=this.options.paper.snapToGrid({x:t.clientX,y:t.clientY}),i=e.x-this._localX,n=e.y-this._localY;this._localX=e.x,this._localY=e.y,this._evt=t,this.triggerAction(this._action,"pointermove",t,e.x,e.y,i,n)}},pointerup:function(t){var e=this._action;if(e){this._action=null,this._evt=null;var i=this.options.paper.snapToGrid({x:t.clientX,y:t.clientY});this.triggerAction(e,"pointerup",t,i.x,i.y),this.undelegateDocumentEvents()}},onRemove:function(){this._action&&this._evt&&this.pointerup(this._evt),this.options.graph.hasActiveBatch("halo")&&this.stopBatch()},onSetTheme:function(){this.setPieIcons()},removeElement:function(){this.options.cellView.model.remove()},toggleUnlink:function(){var t=0<this.options.graph.getConnectedLinks(this.options.cellView.model).length;this.$handles.children(".unlink").toggleClass("hidden",!t)},toggleFork:function(){var t=this.options.cellView.model.clone(),e=this.options.paper.createViewForModel(t),i=this.options.paper.options.validateConnection(this.options.cellView,null,e,null,"target");this.$handles.children(".fork").toggleClass("hidden",!i),e.remove(),t=null},toggleState:function(e){if(this.isRendered()){var t=this.$el;if(w.util.forIn(this.$pieToggles,function(t){t.removeClass("open")}),this.isOpen())this.trigger("state:close",e),t.removeClass("open");else{if(this.trigger("state:open",e),e){var i=w.util.toArray(this.options.pieToggles).find(function(t){return t.name===e});i&&t.attr({"data-pie-toggle-position":i.position,"data-pie-toggle-name":i.name}),this.$pieToggles[e].addClass("open")}t.addClass("open")}}},isOpen:function(t){return!!this.isRendered()&&(t?this.$pieToggles[t].hasClass("open"):this.$el.hasClass("open"))},isRendered:function(){return void 0!==this.$box}},{clear:function(t){t.trigger("halo:create")}});t.Halo=e}(this.joint.ui=this.joint.ui||{},$,joint);