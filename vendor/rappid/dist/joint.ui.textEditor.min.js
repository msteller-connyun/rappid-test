/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,a,e,d){"use strict";a=a&&a.hasOwnProperty("default")?a.default:a,e=e&&e.hasOwnProperty("default")?e.default:e;var o=d.mvc.View.extend({options:{text:void 0,newlineCharacterBBoxWidth:10,placeholder:void 0,focus:!0,debug:!1,useNativeSelection:!0,annotateUrls:!1,urlAnnotation:{attrs:{class:"url-annotation",fill:"lightblue","text-decoration":"underline"}},textareaAttributes:{autocorrect:"off",autocomplete:"off",autocapitalize:"off",spellcheck:"false",tabindex:"0"}},className:"text-editor",events:{"keyup textarea":"onKeyup","input textarea":"onInput","copy textarea":"onCopy","cut textarea":"onCut","paste textarea":"onPaste","mousedown .char-selection-box":"onMousedown","dblclick .char-selection-box":"onDoubleClick","click .char-selection-box":"onTripleClick"},selection:{start:null,end:null},selecting:!1,init:function(){d.util.bindAll(this,"onMousedown","onMousemove","onMouseup","onDoubleClick","onTripleClick","onKeydown","onAfterPaste","onAfterKeydown"),this.setTextElement(this.options.text),a(document.body).on("mousemove",this.onMousemove),a(document.body).on("mouseup",this.onMouseup),a(document.body).on("keydown",this.onKeydown),this.options.cellView?this.$viewport=a(this.options.cellView.paper.cells):this.$viewport=a(this.options.text),this.options.annotations&&this.setAnnotations(this.options.annotations)},setTextElement:function(t){this.$elText&&this.unbindTextElement(),this.options.text=t,this.$elText=a(t),this.$elText.on("mousedown",this.onMousedown),this.$elText.on("dblclick",this.onDoubleClick),this.$elText.on("click",this.onTripleClick)},render:function(t){this.$caret=a("<div>",{class:"caret"}),this.$selection=a("<div>"),this.$selectionBox=a("<div>",{class:"char-selection-box"}),this.$el.append(this.$caret,this.$selection),this.$textareaContainer=a("<div>",{class:"textarea-container"}),this.$textarea=a("<textarea>",this.options.textareaAttributes),this.textarea=this.$textarea[0],this._textContent=this.textarea.value=this.getTextContent(),this._textareaValueBeforeInput=this.textarea.value,this.$textareaContainer.append(this.textarea),this.options.focus&&this.$el.append(this.$textareaContainer),a(t||document.body).append(this.$el);var e=d.V(this.options.text).bbox();return this.$textareaContainer.css({left:e.x,top:e.y}),this.focus(),d.V(this.options.text).attr("cursor","text"),this.selectAll(),this},annotateURLBeforeCaret:function(t){var e=this.getURLBoundary(Math.max(t-1,0));return!!e&&(this.annotateURL(this.getAnnotations()||[],e[0],e[1]),!0)},hasSelection:function(){return d.util.isNumber(this.selection.start)&&d.util.isNumber(this.selection.end)&&this.selection.start!==this.selection.end},textContentHasChanged:function(){return this._textContent!==this.textarea.value},restoreTextAreaSelectionDirection:function(){this._selectionDirection&&(this.textarea.selectionDirection=this._selectionDirection)},storeSelectionDirection:function(){this._selectionDirection=this.textarea.selectionDirection},onKeydown:function(t){this.options.debug&&console.log("onKeydown(): ",t.keyCode),this.hasSelection()&&(this.deselect(),this.restoreTextAreaSelectionDirection()),setTimeout(this.onAfterKeydown,0),this._copied=!1,this._selectionStartBeforeInput=this.textarea.selectionStart,this._selectionEndBeforeInput=this.textarea.selectionEnd},onAfterKeydown:function(){this.$textarea.is(":focus")&&(this.storeSelectionDirection(),this.textarea.selectionStart===this.textarea.selectionEnd?this.setCaret(this.textarea.selectionStart):this.select(this.textarea.selectionStart,this.textarea.selectionEnd))},onKeyup:function(t){this.textContentHasChanged()&&this.onInput(t)},onCopy:function(t){this._copied||this.copyToClipboard()},onCut:function(t){this._copied||this.copyToClipboard()},copyToClipboard:function(){document.queryCommandSupported&&document.queryCommandSupported("copy")&&(this._copied=!0,document.execCommand("copy"))},onInput:function(t){if(this.textContentHasChanged()){var e=this.textarea.value.length-this._textareaValueBeforeInput.length,n={start:this._selectionStartBeforeInput,end:this._selectionEndBeforeInput},i={start:this.textarea.selectionStart,end:this.textarea.selectionEnd};this.options.debug&&console.log("onInput()",t,"selectionBeforeInput",n,"selectionAfterInput",i,"diffLength",e);var o=this.inferTextOperationType(n,i,e),s=!1,r=this.getAnnotations();if(this.options.annotateUrls&&"insert"===o){var a=this.textarea.value.substr(n.start,e);this.options.debug&&console.log("onInput()","inserted text",a),/\s/.test(a)&&(s=this.annotateURLBeforeCaret(n.start))&&(r=this.shiftAnnotations(r,i.end,e))}if(r&&(s||(r=this.annotate(r,n,i,e)),this.options.debug&&console.log("onInput()","modified annotations",r),this._currentAnnotationAttributes&&"insert"===o)){var l={start:n.start,end:i.end,attrs:this._currentAnnotationAttributes};r.push(l),this._currentAnnotationAttributes=void 0,this.options.debug&&console.log("onInput()","insert annotation",l,"final annotations",r)}this._annotations=r,this.trigger("text:change",this.textarea.value,this._textareaValueBeforeInput,r,n,i),this._selectionBeforeInput=i,this._textareaValueBeforeInput=this.textarea.value,this._textContent=this.textarea.value}},onPaste:function(t){this.options.debug&&console.log("onPaste()"),this._textareaValueBeforeInput=this.textarea.value,setTimeout(this.onAfterPaste,0)},onAfterPaste:function(){this.setCaret(this.textarea.selectionStart)},onMousedown:function(t){if(3!==t.originalEvent.detail){this.options.debug&&console.log("onMousedown()");var e=this.getCharNumFromEvent(t);this.startSelecting(),this.select(e),t.preventDefault(),t.stopPropagation()}},onMousemove:function(t){if(this.selectionInProgress()){this.options.debug&&console.log("onMousemove()");var e=this.getCharNumFromEvent(t);this.storeSelectionDirection(),this.select(null,e),t.preventDefault(),t.stopPropagation()}},onMouseup:function(t){this.selectionInProgress()&&(this.options.debug&&console.log("onMouseup()"),this.stopSelecting(),this.trigger("select:changed",this.selection.start,this.selection.end))},onDoubleClick:function(t){this.options.debug&&console.log("onDoubleClick()");var e=this.getCharNumFromEvent(t),n=this.getWordBoundary(e);this.select(n[0],n[1]),t.preventDefault(),t.stopPropagation()},onTripleClick:function(t){3===t.originalEvent.detail&&(this.options.debug&&console.log("onTripleClick()"),this.hideCaret(),this.selectAll(),t.preventDefault(),t.stopPropagation())},findAnnotationsUnderCursor:function(t,e){return d.V.findAnnotationsAtIndex(t,e)},findAnnotationsInSelection:function(t,e,n){return d.V.findAnnotationsBetweenIndexes(t,e,n)},inferTextOperationType:function(t,e,n){return t.start===t.end&&e.start===e.end&&0<n?"insert":t.start===t.end&&e.start===e.end&&n<=0?"delete-single":t.start!==t.end&&e.start===e.end&&e.start===t.start?"delete":t.start!==t.end&&e.start!==t.start?"delete-insert":void 0},annotate:function(t,o,s,r){var a=[],l=this.inferTextOperationType(o,s,r);return d.util.toArray(t).forEach(function(t){var e,n;switch(l){case"insert":t.start<o.start&&o.start<=t.end?t.end+=r:t.start>=o.start&&(t.start+=r,t.end+=r);break;case"delete-single":t.start<o.start&&o.start<=t.end&&o.start!==s.start?t.end+=r:t.start<=o.start&&o.start<t.end&&o.start===s.start?t.end+=r:t.start>=o.start&&(t.start+=r,t.end+=r);break;case"delete":t.start<=o.start&&o.start<=t.end?o.end<=t.end?t.end+=r:t.end+=s.start-t.end:t.start>=o.start&&t.start<o.end?(e=t.end-t.start,n=o.end-t.start,t.start=o.start,t.end=t.start+e-n):t.start>=o.end&&(t.start+=r,t.end+=r);break;case"delete-insert":if(t.start<=o.start&&o.start<=t.end)o.start<t.end&&(o.end>t.end?t.end=s.end:t.end=s.end+(t.end-o.end));else if(t.start>=o.start&&t.start<=o.end){var i=s.start-o.start;n=o.end-t.start,e=t.end-t.start,t.start=o.start+i,t.end=t.start+e-n}else t.start>=o.start&&t.end<=o.end?t.start=t.end=0:t.start>=o.end&&(t.start+=r,t.end+=r);break;default:this.options.debug&&console.log("ui.TextEditor: Unknown text operation.")}t.end>t.start&&a.push(t)},this),a},shiftAnnotations:function(t,e,n){return d.V.shiftAnnotations(t,e,n)},setCurrentAnnotation:function(t){this._currentAnnotationAttributes=t},setAnnotations:function(t){this._annotations=t},getAnnotations:function(){return this._annotations},getCombinedAnnotationAttrsAtIndex:function(e,t){var n={};return d.util.toArray(t).forEach(function(t){void 0===t.start&&void 0===t.end?d.V.mergeAttrs(n,t.attrs):e>=t.start&&e<t.end&&d.V.mergeAttrs(n,t.attrs)}),n},getSelectionAttrs:function(t,e){var n=t.start,i=t.end;if(n===i&&0===n)return this.getCombinedAnnotationAttrsAtIndex(n,e);if(n===i)return this.getCombinedAnnotationAttrsAtIndex(n-1,e);for(var o,s=n;s<i;s++){var r=this.getCombinedAnnotationAttrsAtIndex(s,e);if(o&&!d.util.isEqual(o,r)){o=d.util.flattenObject(d.V.mergeAttrs({},o)),r=d.util.flattenObject(d.V.mergeAttrs({},r));var a={};d.util.forIn(r,function(t,e){o[e]===r[e]&&d.util.setByPath(a,e,t)}),o=a}else o=r}return o},getTextContent:function(){var t=this.options.text,e=d.V(t).find(".v-line");return 0===e.length?t.textContent:e.reduce(function(t,e,n,i){var o=e.node.textContent;return e.hasClass("v-empty-line")&&(o=""),n===i.length-1?t+o:t+o+"\n"},"")},startSelecting:function(){this.selecting=!0},stopSelecting:function(){this.selecting=!1},selectionInProgress:function(){return!0===this.selecting},selectAll:function(){return this.select(0,this.getNumberOfChars())},select:function(t,e){return this.options.debug&&console.log("select(",t,e,")"),void 0===e&&(e=t),d.util.isNumber(t)&&(this.selection.start=t),d.util.isNumber(e)&&(this.selection.end=e),d.util.isNumber(this.selection.end)||(this.selection.end=this.selection.start),d.util.isNumber(this.selection.start)&&d.util.isNumber(this.selection.end)&&(this.selection.start===this.selection.end?(this.clearSelection(),this.focus(),this.setCaret(this.selection.start)):(this.hideCaret(),this.renderSelection(this.selection.start,this.selection.end)),this.trigger("select:change",this.selection.start,this.selection.end)),this},setTextAreaSelection:function(t,e){var n={start:t,end:e};n=this.normalizeSelectionRange(n),this.textarea.focus(),this.textarea.selectionStart=n.start,this.textarea.selectionEnd=n.end},renderSelection:function(t,e){this.options.debug&&console.log("renderSelection()");var n={start:t,end:e};if(n=this.normalizeSelectionRange(n),this.clearSelection(),this.options.useNativeSelection){this.$viewport&&(this._viewportUserSelectBefore=this.$viewport.css("user-select"),this.$viewport.css({"-webkit-user-select":"all","-moz-user-select":"all","user-select":"all"}));var i=n.end-n.start;this.selectTextInElement(this.options.text,n.start,i)}else this.renderSelectionBoxes(n.start,n.end)},normalizeSelectionStartAndLength:function(t,e,n){var i=t.substr(0,e),o=t.substr(e,n);e-=this.countLineBreaks(i),n-=this.countLineBreaks(o);var s=this.countEmptyLines(i);return n+=s,n-=s,{start:e+=s,length:n+=this.countEmptyLines(o)}},selectTextInElement:function(e,n,i){if(d.util.isFunction(e.selectSubString)&&this.selectTextInElementUsingSelectSubString(e,n,i),!this.actualSelectionMatchesExpectedSelection(n,i))try{this.selectTextInElementUsingRanges(e,n,i)}catch(t){this.options.debug&&console.log(t),d.util.isFunction(e.selectSubString)&&this.selectTextInElementUsingSelectSubString(e,n,i)}},selectTextInElementUsingSelectSubString:function(t,e,n){var i=this.normalizeSelectionStartAndLength(this.getTextContent(),e,n);try{t.selectSubString(i.start,i.length)}catch(t){this.options.debug&&console.log(t)}},selectTextInElementUsingRanges:function(t,e,n){var i=window.getSelection();i.removeAllRanges();var o=this.normalizeSelectionStartAndLength(this.getTextContent(),e,n);e=0+o.start,n=0+o.length;for(var s,r,a,l,h,c,u=this.getTextNodesFromDomElement(t),d=0,g=e+n;0<n&&0<u.length;)l=(a=d)+(s=u.shift()).length,(e<=a&&a<g||e<l&&l<=g||a<=e&&e<l||a<g&&g<=l)&&(h=Math.max(e-a,0),c=Math.min(h+Math.min(n,s.length),l),(r=document.createRange()).setStart(s,h),r.setEnd(s,c),i.addRange(r),n-=c-h),d+=s.length},actualSelectionMatchesExpectedSelection:function(t,e){var n=window.getSelection().toString();return this.getExpectedSelectedContent(t,e)===(n=n.replace(/\s/g," "))},getExpectedSelectedContent:function(t,e){var n=this.getTextContent().substr(t,e);return n=(n=(n=n.replace(/(\n\r|\r|\n){2,}/g,"-")).replace(/\n\r|\r|\n/g,"")).replace(/\s/g," ")},getTextNodesFromDomElement:function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var o=t.childNodes[n];void 0!==o.tagName?e=e.concat(this.getTextNodesFromDomElement(o)):e.push(o)}return e},renderSelectionBoxes:function(e,n){this.options.debug&&console.log("renderSelectionBoxes()"),this.$selection.empty();for(var t,i,o,s=this.getFontSize(),r=this.getTextTransforms(),a=r.rotation,l=e;l<n;l++){var h=this.$selectionBox.clone();try{o=this.getCharBBox(l)}catch(t){this.trigger("select:out-of-range",e,n);break}i&&0===a&&Math.round(o.y)===Math.round(i.y)&&Math.round(o.height)===Math.round(i.height)&&Math.round(o.x)===Math.round(i.x+i.width)?t.css({width:"+="+o.width}):(h.css({left:o.x,top:o.y-o.height,width:o.width,height:o.height,"-webkit-transform":"rotate("+a+"deg)","-webkit-transform-origin":"0% 100%","-moz-transform":"rotate("+a+"deg)","-moz-transform-origin":"0% 100%"}),this.$selection.append(h),t=h),i=o}o&&this.$textareaContainer.css({left:o.x,top:o.y-s*r.scaleY})},clearSelection:function(){return this.options.debug&&console.log("clearSelection()"),this.$selection.empty(),this.options.text.selectSubString&&(this.$viewport&&this._viewportUserSelectBefore&&this.$viewport.css({"-webkit-user-select":this._viewportUserSelectBefore,"-moz-user-select":this._viewportUserSelectBefore,"user-select":this._viewportUserSelectBefore}),window.getSelection().removeAllRanges()),this},deselect:function(){return this.options.debug&&console.log("deselect()"),this.stopSelecting(),this.clearSelection(),this.setTextAreaSelection(this.selection.start,this.selection.end),this},getSelectionStart:function(){return this.selection.start},getSelectionEnd:function(){return this.selection.end},getSelectionRange:function(){return this.normalizeSelectionRange(this.selection)},normalizeSelectionRange:function(t){return(t=d.util.clone(t)).start>t.end&&(t.end=[t.start,t.start=t.end][0]),t},getSelectionLength:function(){var t=this.getSelectionRange();return t.end-t.start},getSelection:function(){var t=this.getSelectionRange();return this.getTextContent().slice(t.start,t.end)},getWordBoundary:function(t){for(var e=this.textarea.value,n=/\W/,i=t;i;){if(n.test(e[i])){i+=1;break}i-=1}for(var o=this.getNumberOfChars(),s=t;s<=o&&!n.test(e[s]);)s+=1;return i<s?[i,s]:[s,i]},getURLBoundary:function(t){for(var e=this.textarea.value,n=/\s/,i=t;i;){if(n.test(e[i])){i+=1;break}i-=1}for(var o=this.getNumberOfChars(),s=t;s<=o&&!n.test(e[s]);)s+=1;if(/[-a-zA-Z0-9@:%_+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_+.~#?&//=]*)?/.test(e.substring(i,s)))return[i,s]},annotateURL:function(t,e,n){var i=this.textarea.value.substring(e,n),o=d.util.assign({url:i},this.options.urlAnnotation);return o.start=e,o.end=n,d.util.isEqual(o,t[t.length-1])||t.push(o),t},getCharBBox:function(t){if(this.isLineEnding(t)){var e=this.getCharBBox(t-1);return e.x=e.x2,e.y=e.y2,e.width=this.options.newlineCharacterBBoxWidth||10,e}var n=this.realToSvgCharNum(t),i=this.options.text,o=i.getStartPositionOfChar(n),s=i.getEndPositionOfChar(n),r=i.getExtentOfChar(n);o=this.localToScreenCoordinates(o),s=this.localToScreenCoordinates(s);var a=this.getTextTransforms();return{x:o.x,y:o.y,width:r.width*a.scaleX,height:r.height*a.scaleY,x2:s.x,y2:s.y}},realToSvgCharNum:function(t){for(var e=0,n=0;n<=t;n++)this.isLineEnding(n)&&(e+=1);return t-e},selectionStartToSvgCharNum:function(t){return t-this.nonEmptyLinesBefore(t)},isLineEnding:function(t){var e=this.textarea.value;return"\n"===e[t]&&0<t&&"\n"!==e[t-1]},svgToRealCharNum:function(t){for(var e=0,n=0;n<=t+e;n++)this.isLineEnding(n)&&(e+=1);return t+e},localToScreenCoordinates:function(t){return a(this.options.text).show(),d.V.transformPoint(t,this.options.text.getCTM())},getNumberOfChars:function(){return this.getTextContent().length},getCharNumFromEvent:function(t){var e=this.options.text,n=t.clientX,i=t.clientY,o=d.V(e).toLocalPoint(n,i),s=e.getCharNumAtPosition(o);if(s<0)return this.getNumberOfChars();var r=this.localToScreenCoordinates(o),a=this.getCharBBox(this.svgToRealCharNum(s));return Math.abs(a.x-r.x)<Math.abs(a.x+a.width-r.x)?this.svgToRealCharNum(s):this.svgToRealCharNum(s)+1},lineNumber:function(t){var e=this.textarea.value.substr(0,t);return this.countLineBreaks(e)},emptyLinesBefore:function(t){for(var e=this.textarea.value.split(/\n\r|\r|\n/g),n=0,i=this.lineNumber(t)-1;0<=i;i--)e[i]||(n+=1);return n},countLineBreaks:function(t){return(t.match(/\n\r|\r|\n/g)||[]).length},countEmptyLines:function(t){return(t.match(/(\n\r|\r|\n){2,}/g)||[]).length},nonEmptyLinesBefore:function(t){return this.lineNumber(t)-this.emptyLinesBefore(t)},isEmptyLine:function(t){return!this.textarea.value.split(/\n\r|\r|\n/g)[t]},isEmptyLineUnderSelection:function(t){var e=this.lineNumber(t);return this.isEmptyLine(e)},getTextTransforms:function(){var t=this.options.text.getCTM();return d.V.decomposeMatrix(t)},getFontSize:function(){return parseInt(d.V(this.options.text).attr("font-size"),10)},getTextAnchor:function(){return d.V(this.options.text).attr("text-anchor")||""},setCaret:function(t,e){d.util.isObject(t)&&(e=t,t=void 0),e=e||{};var n,i=this.options.text,o=this.getNumberOfChars(),s=this.selection.start,r=this.textarea.value;void 0!==t&&(t=Math.min(Math.max(t,0),o),s=this.selection.start=this.selection.end=t),e.silent||this.trigger("caret:change",s),this.setTextAreaSelection(s,s),this.options.debug&&console.log("setCaret(",t,e,")","selectionStart",s,"isLineEnding",this.isLineEnding(s),"isEmptyLineUnderSelection",this.isEmptyLineUnderSelection(s),"svgCharNum",this.selectionStartToSvgCharNum(s),"nonEmptyLinesBefore",this.nonEmptyLinesBefore(s));try{var a;n=this.isEmptyLineUnderSelection(s)||!this.isLineEnding(s)&&r.length!==s?(a=this.selectionStartToSvgCharNum(s),i.getStartPositionOfChar(a)):(a=this.selectionStartToSvgCharNum(s)-1,i.getEndPositionOfChar(a))}catch(t){this.trigger("caret:out-of-range",s),n={x:0,y:0}}var l=this.localToScreenCoordinates(n),h=this.getTextTransforms(),c=h.rotation,u=this.getFontSize()*h.scaleY;return this.options.placeholder&&this.$caret.toggleClass("placeholder",0===o),this.$caret.css({left:l.x,top:l.y+(o?-u:0),height:u,"line-height":u+"px","font-size":u+"px","-webkit-transform":"rotate("+c+"deg)","-webkit-transform-origin":"0% 100%","-moz-transform":"rotate("+c+"deg)","-moz-transform-origin":"0% 100%"}).attr({"text-anchor":this.getTextAnchor()}).show(),this.$textareaContainer.css({left:l.x,top:l.y+(o?-u:0)}),this.focus(),this},focus:function(){return this.options.debug&&console.log("focus()"),this.showCaret(),this},blur:function(){return this.options.debug&&console.log("blur()"),this.hideCaret(),this},showCaret:function(){return this.options.debug&&console.log("showCaret()"),this.$caret.show(),this},hideCaret:function(){return this.options.debug&&console.log("hideCaret()"),this.$caret.hide(),this},unbindTextElement:function(){this.$elText.off("mousedown",this.onMousedown),this.$elText.off("dblclick",this.onDoubleClick),this.$elText.off("click",this.onTripleClick)},onRemove:function(){this.deselect(),this.unbindTextElement(),a(document.body).off("mousemove",this.onMousemove),a(document.body).off("mouseup",this.onMouseup),a(document.body).off("keydown",this.onKeydown),d.V(this.options.text).attr("cursor","")}},d.util.assign({getTextElement:function(t){var e=t.tagName.toUpperCase();if("TEXT"===e||"TSPAN"===e||"TEXTPATH"===e)return"TEXT"===e?t:this.getTextElement(t.parentNode)},edit:function(t,s){var e=!1!==(s=s||{}).update;this.options=d.util.assign({},s,{update:e});var r=this.getTextElement(t);if(r){var n;if(this.close(),this.ed=new o(d.util.assign({text:r},s)),this.ed.on("all",this.trigger,this),s.cellView){if(n=s.cellView.paper.el,this.cellViewUnderEdit=s.cellView,this.cellViewUnderEditInteractiveOption=this.cellViewUnderEdit.options.interactive,this.cellViewUnderEdit.options.interactive=!1,s.annotationsProperty&&!this.ed.getAnnotations()){var i=this.cellViewUnderEdit.model.prop(s.annotationsProperty);i&&this.ed.setAnnotations(this.deepCloneAnnotations(i))}}else n=d.V(r).svg().parentNode;return e&&this.ed.on("text:change",function(t,e,n){if(s.cellView){var i=null;if(s.textProperty&&(s.cellView.model.isLink()&&"labels"===s.textProperty.substr(0,"labels".length)&&(i=d.V(a(d.V(r).node).closest(".label")[0]).index()),s.cellView.model.prop(s.textProperty,t,{textEditor:this.ed.cid})),s.annotationsProperty&&s.cellView.model.prop(s.annotationsProperty,this.deepCloneAnnotations(n),{rewrite:!0,textEditor:this.ed.cid}),null!==i){var o=d.V(s.cellView.el).find(".label");r=o[i].findOne("text"),this.ed.setTextElement(r.node)}}else d.V(r).text(t,n)},this),this.ed.render(n),this}this.options.debug&&console.log("ui.TextEditor: cannot find a text element.")},close:function(){if(this.ed){if(this.ed.options.annotateUrls){var t=this.ed.getSelectionStart();if(!this.findAnnotationsUnderCursor().find(function(t){return!!t.url&&t}))this.ed.annotateURLBeforeCaret(t)&&this.applyAnnotations(this.getAnnotations())}this.ed.remove(),this.cellViewUnderEdit&&(this.cellViewUnderEdit.options.interactive=this.cellViewUnderEditInteractiveOption),this.ed=this.cellViewUnderEdit=this.cellViewUnderEditInteractiveOption=void 0}},applyAnnotations:function(t){var e=this.options;if(this.ed&&e.update){e.cellView&&e.annotationsProperty?(e.cellView.model.prop(e.annotationsProperty,this.deepCloneAnnotations(t),{rewrite:!0}),this.ed.setAnnotations(t)):d.V(this.ed.options.text).text(this.ed.getTextContent(),t);var n=this.getSelectionRange();0<this.getSelectionLength()?this.ed.select(n.start,n.end):this.ed.setCaret()}},deepCloneAnnotations:function(t){try{return JSON.parse(JSON.stringify(t))}catch(t){return}},proxy:function(t,e){if(this.ed)return this.ed[t].apply(this.ed,e)},setCurrentAnnotation:function(t){return this.proxy("setCurrentAnnotation",arguments)},getAnnotations:function(){return this.proxy("getAnnotations",arguments)},setCaret:function(){return this.proxy("setCaret",arguments)},deselect:function(){return this.proxy("deselect",arguments)},selectAll:function(){return this.proxy("selectAll",arguments)},select:function(){return this.proxy("select",arguments)},getNumberOfChars:function(){return this.proxy("getNumberOfChars",arguments)},getCharNumFromEvent:function(){return this.proxy("getCharNumFromEvent",arguments)},getWordBoundary:function(){return this.proxy("getWordBoundary",arguments)},findAnnotationsUnderCursor:function(){return this.proxy("findAnnotationsUnderCursor",[this.ed.getAnnotations(),this.ed.getSelectionStart()])},findAnnotationsInSelection:function(){if(this.ed){var t=this.ed.getSelectionRange();return this.proxy("findAnnotationsInSelection",[this.ed.getAnnotations(),t.start,t.end])}},getSelectionAttrs:function(t){if(this.ed){var e=this.ed.getSelectionRange();return this.proxy("getSelectionAttrs",[e,t])}},getSelectionLength:function(){return this.proxy("getSelectionLength",arguments)},getSelectionRange:function(){return this.proxy("getSelectionRange",arguments)}},e.Events));t.TextEditor=o}(this.joint.ui=this.joint.ui||{},$,Backbone,joint);