/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,a,d){"use strict";a=a&&a.hasOwnProperty("default")?a.default:a;var e=d.mvc.View.extend({className:"free-transform",events:{"mousedown .resize":"startResizing","mousedown .rotate":"startRotating","touchstart .resize":"startResizing","touchstart .rotate":"startRotating"},DIRECTIONS:["nw","n","ne","e","se","s","sw","w"],POSITIONS:["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"],options:{cellView:void 0,rotateAngleGrid:15,preserveAspectRatio:!1,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,allowOrthogonalResize:!0,allowRotation:!0,clearAll:!0,clearOnBlankPointerdown:!0},init:function(){var t=this.options;t.cellView?d.util.defaults(t,{cell:t.cellView.model,paper:t.cellView.paper,graph:t.cellView.paper.model}):t.paper&&t.cell&&d.util.defaults(t,{cellView:t.cell.findView(t.paper),graph:t.paper.model}),d.util.bindAll(this,"update","remove","pointerup","pointermove");var e=t.paper,i=t.graph;t.clearAll&&this.constructor.clear(e),a(document.body).on("mousemove touchmove",this.pointermove),a(document).on("mouseup touchend",this.pointerup),this.listenTo(i,"all",this.update),this.listenTo(e,"scale translate",this.update),this.listenTo(i,"reset",this.remove),this.listenTo(t.cell,"remove",this.remove),t.clearOnBlankPointerdown&&this.listenTo(e,"blank:pointerdown",this.remove),e.$el.append(this.el),this.constructor.registerInstanceToPaper(this,e)},renderHandles:function(){var e=a("<div/>").prop("draggable",!1),t=e.clone().addClass("rotate"),i=this.POSITIONS.map(function(t){return e.clone().addClass("resize").attr("data-position",t)});this.$el.empty().append(i,t)},render:function(){this.renderHandles(),this.$el.attr("data-type",this.options.cell.get("type")),this.$el.toggleClass("no-orthogonal-resize",this.options.preserveAspectRatio||!this.options.allowOrthogonalResize),this.$el.toggleClass("no-rotation",!this.options.allowRotation),this.update()},update:function(){var t=this.options.paper.matrix(),e=this.options.cell.getBBox();e.x*=t.a,e.x+=t.e,e.y*=t.d,e.y+=t.f,e.width*=t.a,e.height*=t.d;var i=d.g.normalizeAngle(this.options.cell.get("angle")||0),o="rotate("+i+"deg)";this.$el.css({width:e.width+4,height:e.height+4,left:e.x-3,top:e.y-3,transform:o,"-webkit-transform":o,"-ms-transform":o});var n=Math.floor(i*(this.DIRECTIONS.length/360));if(n!=this._previousDirectionsShift){var s=this.DIRECTIONS.slice(n).concat(this.DIRECTIONS.slice(0,n));this.$(".resize").removeClass(this.DIRECTIONS.join(" ")).each(function(t,e){a(e).addClass(s[t])}),this._previousDirectionsShift=n}},calculateTrueDirection:function(t){var e=this.options.cell,i=d.g.normalizeAngle(e.get("angle")),o=this.POSITIONS.indexOf(t);return o+=Math.floor(i*(this.POSITIONS.length/360)),o%=this.POSITIONS.length,this.POSITIONS[o]},startResizing:function(t){t.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var e=a(t.target).data("position"),i=this.calculateTrueDirection(e),o=0,n=0;e.split("-").forEach(function(t){o={left:-1,right:1}[t]||o,n={top:-1,bottom:1}[t]||n});var s=this.toValidResizeDirection(e),r={"top-right":"bottomLeft","top-left":"corner","bottom-left":"topRight","bottom-right":"origin"}[s];this._initial={angle:d.g.normalizeAngle(this.options.cell.get("angle")||0),resizeX:o,resizeY:n,selector:r,direction:s,relativeDirection:e,trueDirection:i},this._action="resize",this.startOp(t.target)},toValidResizeDirection:function(t){return{top:"top-left",bottom:"bottom-right",left:"bottom-left",right:"top-right"}[t]||t},startRotating:function(t){t.stopPropagation(),this.options.graph.startBatch("free-transform",{freeTransform:this.cid});var e=this.options.cell.getBBox().center(),i=this.options.paper.snapToGrid({x:t.clientX,y:t.clientY});this._initial={centerRotation:e,modelAngle:d.g.normalizeAngle(this.options.cell.get("angle")||0),startAngle:d.g.point(i).theta(e)},this._action="rotate",this.startOp(t.target)},pointermove:function(t){if(this._action){t=d.util.normalizeEvent(t);var e=this.options,i=e.paper.snapToGrid({x:t.clientX,y:t.clientY}),o=e.paper.options.gridSize,n=e.cell,s=this._initial;switch(this._action){case"resize":var r=n.getBBox(),a=d.g.point(i).rotate(r.center(),s.angle).difference(r[s.selector]()),l=s.resizeX?a.x*s.resizeX:r.width,h=s.resizeY?a.y*s.resizeY:r.height;if(l=d.g.snapToGrid(l,o),h=d.g.snapToGrid(h,o),l=Math.max(l,e.minWidth||o),h=Math.max(h,e.minHeight||o),l=Math.min(l,e.maxWidth),h=Math.min(h,e.maxHeight),e.preserveAspectRatio){var p=r.width*h/r.height,c=r.height*l/r.width;l<p?h=c:l=p}r.width==l&&r.height==h||n.resize(l,h,{freeTransform:this.cid,direction:s.direction,relativeDirection:s.relativeDirection,trueDirection:s.trueDirection,ui:!0,minWidth:e.minWidth,minHeight:e.minHeight,maxWidth:e.maxWidth,maxHeight:e.maxHeight,preserveAspectRatio:e.preserveAspectRatio});break;case"rotate":var g=s.startAngle-d.g.point(i).theta(s.centerRotation);n.rotate(d.g.snapToGrid(s.modelAngle+g,e.rotateAngleGrid),!0)}}},pointerup:function(t){this._action&&(this.stopOp(),this.options.graph.stopBatch("free-transform",{freeTransform:this.cid}),this._action=null,this._initial=null)},onRemove:function(){a(document.body).off("mousemove touchmove",this.pointermove),a(document).off("mouseup touchend",this.pointerup),e.unregisterInstanceFromPaper(this,this.options.paper)},startOp:function(t){t&&(a(t).addClass("in-operation"),this._elementOp=t),this.$el.addClass("in-operation"),this.options.paper.undelegateEvents()},stopOp:function(){this._elementOp&&(a(this._elementOp).removeClass("in-operation"),this._elementOp=null),this.$el.removeClass("in-operation"),this.options.paper.delegateEvents()}},{instancesByPaper:{},clear:function(t){t.trigger("freetransform:create"),this.removeInstancesForPaper(t)},removeInstancesForPaper:function(t){d.util.invoke(this.getInstancesForPaper(t),"remove")},getInstancesForPaper:function(t){return this.instancesByPaper[t.cid]||{}},registerInstanceToPaper:function(t,e){this.instancesByPaper[e.cid]||(this.instancesByPaper[e.cid]={}),this.instancesByPaper[e.cid][t.cid]=t},unregisterInstanceFromPaper:function(t,e){this.instancesByPaper[e.cid]&&(this.instancesByPaper[e.cid][t.cid]=null)}});t.FreeTransform=e}(this.joint.ui=this.joint.ui||{},$,joint);