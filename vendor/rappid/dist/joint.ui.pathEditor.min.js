/*! Rappid v3.0.0 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2019-08-09 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


this.joint=this.joint||{},function(t,g,_){"use strict";g=g&&g.hasOwnProperty("default")?g.default:g;var e=_.mvc.View.extend({tagName:"g",svgElement:!0,className:"path-editor",events:{"mousedown .anchor-point":"onAnchorPointPointerDown","mousedown .control-point":"onControlPointPointerDown","mousedown .segment-path":"onSegmentPathPointerDown","touchstart .anchor-point":"onAnchorPointPointerDown","touchstart .control-point":"onControlPointPointerDown","touchstart .segment-path":"onSegmentPathPointerDown","dblclick .anchor-point":"onAnchorPointDoubleClick","dblclick .control-point":"onControlPointDoubleClick","dblclick .segment-path":"onSegmentPathDoubleClick"},documentEvents:{mousemove:"onPointerMove",touchmove:"onPointerMove",mouseup:"onPointerUp",touchend:"onPointerUp",touchcancel:"onPointerUp"},options:{anchorPointMarkup:'<circle r="2.5"/>',controlPointMarkup:'<circle r="2.5"/>'},init:function(){var t=this.pathNode=_.V(this.options.pathElement).normalizePath().node;this.segList=t.pathSegList,this.svgRoot=_.V(t.ownerSVGElement),this.$document=g(t.ownerDocument),this.render()},onRemove:function(){this.undelegateDocumentEvents(),this.clear()},clear:function(){this.vel.empty(),this.directionPaths=[],this.segmentPaths=[],this.controlPoints=[],this.anchorPoints=[],this._subPathIndices=[0],this.trigger("clear",this.pathNode)},_transformPoint:function(t,e,i){return _.V.transformPoint(_.g.Point(t,e),i)},_getPathCTM:function(){return this.pathNode.getCTM()},render:function(){this.clear();var t,e,i,n=this.vel,o=this._getPathCTM(),a=_.V(this.options.anchorPointMarkup).addClass("anchor-point"),r=_.V(this.options.controlPointMarkup).addClass("control-point"),s=_.V('<path class="direction-path"/>'),h=_.V('<path class="segment-path"/>'),c=this.segList,g=this.anchorPoints,p=this.controlPoints,P=this.directionPaths,l=this.segmentPaths,S=this._subPathIndices;for(i=e=t=0;t<c.numberOfItems;t++){var u=c.getItem(t),d=this._transformPoint(u.x,u.y,o),m=d.x,v=d.y;if(u.pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH&&(g[t]=a.clone().attr({index:t,cx:m,cy:v})),u.pathSegType!=SVGPathSeg.PATHSEG_MOVETO_ABS){var f=h.clone().attr("index",t).node;switch(f.pathSegList.initialize(f.createSVGPathSegMovetoAbs(e,i)),u.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:var y=c.getItem(S[0]),x=this._transformPoint(y.x,y.y,o);m=x.x,v=x.y,f.pathSegList.appendItem(f.createSVGPathSegLinetoAbs(m,v)),S.unshift(t+1);break;case SVGPathSeg.PATHSEG_LINETO_ABS:f.pathSegList.appendItem(f.createSVGPathSegLinetoAbs(m,v));break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var E=this._transformPoint(u.x1,u.y1,o),C=r.clone().attr({index:t,"attribute-index":1,cx:E.x,cy:E.y}),T=this._transformPoint(u.x2,u.y2,o),A=r.clone().attr({index:t,"attribute-index":2,cx:T.x,cy:T.y});p[t]=[C,A],f.pathSegList.appendItem(f.createSVGPathSegCurvetoCubicAbs(m,v,E.x,E.y,T.x,T.y)),P[t]=[s.clone().attr("d",["M",e,i,"L",E.x,E.y].join(" ")),s.clone().attr("d",["M",m,v,"L",T.x,T.y].join(" "))]}l[t]=f}e=m,i=v}var I=[];l.forEach(function(t){t&&I.push(t)}),P.forEach(function(t){t&&Array.prototype.push.apply(I,t)}),g.forEach(function(t){t&&I.push(t)}),p.forEach(function(t){t&&Array.prototype.push.apply(I,t)}),n.append(I),this.svgRoot.append(n)},startMoving:function(t){var e=_.util.normalizeEvent(t),i=this.$point=g(e.target);this.prevClientX=e.clientX,this.prevClientY=e.clientY;var n=parseInt(this.$point.attr("index"),10);if(i.hasClass("anchor-point"))this.trigger("path:interact"),this.trigger("path:anchor-point:select",n);else if(i.hasClass("control-point")){var o=this.$point.attr("attribute-index");this.trigger("path:interact"),this.trigger("path:control-point:select",n,o)}else this.trigger("path:interact"),this.trigger("path:segment:select",n);e.stopPropagation(),e.preventDefault(),this.pathEditedEventType=null},move:function(t){var e=this.$point;if(e){var i=_.util.normalizeEvent(t),n=i.clientX-this.prevClientX,o=i.clientY-this.prevClientY,a=parseInt(e.attr("index"),10);if(e.hasClass("anchor-point"))this.adjustAnchorPoint(a,n,o);else if(e.hasClass("control-point")){var r=e.attr("attribute-index");this.adjustControlPoint(a,r,n,o)}else this.adjustAnchorPoint(a-1,n,o),this.adjustAnchorPoint(a,n,o);this.prevClientX=i.clientX,this.prevClientY=i.clientY}},adjustControlPoint:function(t,e,i,n){var o=this._getPathCTM(),a=this.segList,r=a.getItem(t),s=this.controlPoints,h=o.inverse();h.e=0,h.f=0;var c=this._transformPoint(i,n,h),g="x"+e,p="y"+e;r[g]+=c.x,r[p]+=c.y;var P=this._transformPoint(r[g],r[p],o);if(s[t][e-1].attr({cx:P.x,cy:P.y}).hasClass("locked")){var l=this.getBoundIndex(t,e),S=1==e?2:1,u=a.getItem(l),d="x"+S,m="y"+S,v=_.g.point(1==e?u.x:r.x,1==e?u.y:r.y),f=_.g.point(r[g],r[p]),y=v.distance(_.g.Point(u[d],u[m])),x=v.move(f,y);u[d]=x.x,u[m]=x.y;var E=this._transformPoint(u[d],u[m],o);s[l][S-1].attr({cx:E.x,cy:E.y}),this.updateDirectionPaths(l),this.updateSegmentPath(l)}this.updateDirectionPaths(t),this.updateSegmentPath(t),this.pathEditedEventType="path:control-point:adjust"},findSubpathIndex:function(t){for(var e=this._subPathIndices,i=0,n=e.length;i<n;i++)if(e[i]<t)return e[i]},findReversedSubpathIndex:function(t){for(var e=this._subPathIndices,i=e.length-1;0<=i;i--)if(e[i]>t)return e[i]},adjustAnchorPoint:function(t,e,i){var n=this._getPathCTM(),o=this.segList,a=o.getItem(t);a.pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH&&(t=this.findSubpathIndex(t),a=o.getItem(t));var r=this.anchorPoints,s=this.controlPoints,h=r.length-1;if((0===t||t===h)&&s[1]&&s[h]){var c=s[1][0],g=s[h][1];c&&c.hasClass("locked")&&c.removeClass("locked"),g&&g.hasClass("locked")&&g.removeClass("locked")}var p=n.inverse();p.e=0,p.f=0;var P=this._transformPoint(e,i,p);a.x+=P.x,a.y+=P.y;var l=this._transformPoint(a.x,a.y,n);if(r[t].attr({cx:l.x,cy:l.y}),a.pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS){a.x2+=P.x,a.y2+=P.y;var S=this._transformPoint(a.x2,a.y2,n);s[t][1].attr({cx:S.x,cy:S.y})}var u=t+1<o.numberOfItems?o.getItem(t+1):0;if(u){if(u.pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS){u.x1+=P.x,u.y1+=P.y;var d=this._transformPoint(u.x1,u.y1,n);s[t+1][0].attr({cx:d.x,cy:d.y}),this.updateDirectionPaths(t+1)}this.updateSegmentPath(t+1)}this.updateDirectionPaths(t),this.updateSegmentPath(t),this.pathEditedEventType="path:anchor-point:adjust"},updateDirectionPaths:function(t){var n=this._getPathCTM(),e=this.segList,o=e.getItem(t),a=this._transformPoint(o.x,o.y,n),r=0<t?e.getItem(t-1):null,s=r?this._transformPoint(r.x,r.y,n):null,i=this.directionPaths[t];Array.isArray(i)&&i.forEach(function(t,e){e++;var i=this._transformPoint(o["x"+e],o["y"+e],n);t.attr("d",["M",1<e||!r?a.x:s.x,1<e||!r?a.y:s.y,i.x,i.y].join(" "))},this)},updateSegmentPath:function(t){var e=this.segList;if(this._subPathIndices.includes(t)){var i=this.findReversedSubpathIndex(t)||e.numberOfItems;if(i--,e.getItem(i).pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH)return;t=i}var n=this.segmentPaths[t];if(n){var o=this._getPathCTM(),a=e.getItem(t-1),r=this._transformPoint(a.x,a.y,o),s=n.createSVGPathSegMovetoAbs(r.x,r.y);n.pathSegList.initialize(s);var h=e.getItem(t),c=this._transformPoint(h.x,h.y,o);switch(h.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:var g=e.getItem(this.findSubpathIndex(t)),p=this._transformPoint(g.x,g.y,o);s=n.createSVGPathSegLinetoAbs(p.x,p.y);break;case SVGPathSeg.PATHSEG_LINETO_ABS:s=n.createSVGPathSegLinetoAbs(c.x,c.y);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var P=this._transformPoint(h.x1,h.y1,o),l=this._transformPoint(h.x2,h.y2,o);s=n.createSVGPathSegCurvetoCubicAbs(c.x,c.y,P.x,P.y,l.x,l.y)}n.pathSegList.appendItem(s)}},stopMoving:function(){if(this.$point=null,this.pathEditedEventType){var t=this.pathNode;this.trigger("path:edit",t),this.trigger(this.pathEditedEventType,t)}this.pathEditedEventType=null},createAnchorPoint:function(t){var e=_.util.normalizeEvent(t),i=_.V(e.target).attr("index"),n=this.pathNode,o=this.segList,a=_.V(n).toLocalPoint(e.pageX,e.pageY),r=o.getItem(i);switch(r.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:case SVGPathSeg.PATHSEG_LINETO_ABS:o.insertItemBefore(n.createSVGPathSegLinetoAbs(a.x,a.y),i);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:var s=o.getItem(i-1),h=_.g.point(s.x,s.y),c=_.g.point(r.x1,r.y1),g=_.g.point(r.x2,r.y2),p=_.g.point(r.x,r.y),P=_.g.bezier.getInversionSolver(h,c,g,p)(a);if(P<0)return;var l=_.g.bezier.getCurveDivider(h,c,g,p)(P);o.insertItemBefore(n.createSVGPathSegCurvetoCubicAbs(l[0].p3.x,l[0].p3.y,l[0].p1.x,l[0].p1.y,l[0].p2.x,l[0].p2.y),i),r.x1=l[1].p1.x,r.y1=l[1].p1.y,r.x2=l[1].p2.x,r.y2=l[1].p2.y}this.render(),this.trigger("path:edit",n),this.trigger("path:anchor-point:create",n)},removeAnchorPoint:function(t){var e,i,n=_.util.normalizeEvent(t),o=parseInt(g(n.target).attr("index"),10),a=this.pathNode,r=this.segList,s=r.getItem(o);switch(s.pathSegType){case SVGPathSeg.PATHSEG_MOVETO_ABS:e=r.getItem(o+1),i=a.createSVGPathSegMovetoAbs(e.x,e.y),r.replaceItem(i,o+1),r.removeItem(o);break;case SVGPathSeg.PATHSEG_LINETO_ABS:r.removeItem(o);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:o+1<=r.numberOfItems-1&&(e=r.getItem(o+1)).pathSegType==SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS&&(e.x1=s.x1,e.y1=s.y1),r.removeItem(o)}this.render(),this.trigger("path:edit",a),this.trigger("path:anchor-point:remove",a);var h=r.numberOfItems;r.getItem(r.numberOfItems-1).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH&&(h-=1),h<2&&this.trigger("path:invalid",a)},lockControlPoint:function(t){var e=_.util.normalizeEvent(t),i=g(e.target),n=this.pathNode,o=parseInt(i.attr("index")),a=i.attr("attribute-index"),r=this.getBoundIndex(o,a),s=1==a?2:1,h=this.controlPoints[r];if(h){var c=i.hasClass("locked");i.toggleClass("locked"),h[s-1].toggleClass("locked"),this.trigger("path:interact"),c?this.trigger("path:control-point:unlock",o,a):this.trigger("path:control-point:lock",o,a),this.adjustControlPoint(o,a,0,0),this.trigger("path:edit",n),this.trigger(this.pathEditedEventType,n),this.pathEditedEventType=null}},getBoundIndex:function(t,e){var i,n,o,a,r,s=this.segList,h=this.anchorPoints,c=h.length-1;return 1==e?0===(i=t-1)&&(n=s.numberOfItems-1,o=s.getItem(n).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH,a=h[0].attr("cx")===h[c].attr("cx"),r=h[0].attr("cy")===h[c].attr("cy"),o&&a&&r&&(i=c)):(i=t+1)===1+c&&(n=s.numberOfItems-1,o=s.getItem(n).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH,a=h[0].attr("cx")===h[c].attr("cx"),r=h[0].attr("cy")===h[c].attr("cy"),o&&a&&r&&(i=1)),i},getControlPointLockedStates:function(){for(var t=this.controlPoints,e=[],i=0;i<t.length;i++)if(t[i]){e[i]=[];for(var n=0;n<=1;n++)if(t[i][n]){var o=n+1;t[i][n].hasClass("locked")?e[i][o]=!0:e[i][o]=!1}}return e},setControlPointLockedStates:function(t){for(var e=this.controlPoints,i=0;i<e.length;i++)if(t[i]&&e[i])for(var n=1;n<=2;n++)t[i][n]&&e[i][n-1]&&(!0===t[i][n]?e[i][n-1].addClass("locked"):e[i][n-1].removeClass("locked"))},convertSegmentPath:function(t){var e,i,n=_.util.normalizeEvent(t),o=_.V(n.target).attr("index"),a=this.pathNode,r=this.segList,s=r.getItem(o);switch(s.pathSegType){case SVGPathSeg.PATHSEG_CLOSEPATH:e=r.getItem(o-1),i=r.getItem(0),r.insertItemBefore(a.createSVGPathSegCurvetoCubicAbs(i.x,i.y,e.x,e.y,i.x,i.y),o);break;case SVGPathSeg.PATHSEG_LINETO_ABS:e=r.getItem(o-1),r.replaceItem(a.createSVGPathSegCurvetoCubicAbs(s.x,s.y,e.x,e.y,s.x,s.y),o);break;case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:r.replaceItem(a.createSVGPathSegLinetoAbs(s.x,s.y),o)}this.render(),this.trigger("path:edit",a),this.trigger("path:segment:convert",a)},addClosePathSegment:function(t){var e=_.util.normalizeEvent(t),i=parseInt(g(e.target).attr("index"),10),n=this.segList;if((0===i||i===n.numberOfItems-1)&&n.getItem(n.numberOfItems-1).pathSegType!=SVGPathSeg.PATHSEG_CLOSEPATH){var o=this.pathNode;n.appendItem(o.createSVGPathSegClosePath()),this.render(),this.trigger("path:edit",o),this.trigger("path:closepath-segment:add",o)}},removeClosePathSegment:function(t){var e=_.util.normalizeEvent(t),i=_.V(e.target).attr("index"),n=this.segList;if(n.getItem(i).pathSegType==SVGPathSeg.PATHSEG_CLOSEPATH){var o=this.pathNode;n.removeItem(i),this.render(),this.trigger("path:edit",o),this.trigger("path:closepath-segment:remove",o)}},onAnchorPointPointerDown:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),1===e.which&&(1<e.originalEvent.detail||(this.startMoving(e),this.delegateDocumentEvents()))},onControlPointPointerDown:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),1===e.which&&(1<e.originalEvent.detail||(this.startMoving(e),this.delegateDocumentEvents()))},onSegmentPathPointerDown:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),1===e.which&&(1<e.originalEvent.detail||(this.startMoving(e),this.delegateDocumentEvents()))},onPointerMove:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),this.move(e)},onPointerUp:function(t){this.undelegateDocumentEvents(),_.util.normalizeEvent(t).stopPropagation(),this.stopMoving()},onAnchorPointDoubleClick:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),e.preventDefault(),1===e.which&&this.removeAnchorPoint(e)},onControlPointDoubleClick:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),e.preventDefault(),1===e.which&&this.lockControlPoint(e)},onSegmentPathDoubleClick:function(t){var e=_.util.normalizeEvent(t);e.stopPropagation(),e.preventDefault(),1===e.which&&this.createAnchorPoint(e)}});t.PathEditor=e}(this.joint.ui=this.joint.ui||{},$,joint);